<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus">


<title data-react-helmet="true">Application Access to a StatefulSet | Kubernetes Training</title>

<meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"><meta data-react-helmet="true" property="og:title" content="Kubernetes Training"><meta data-react-helmet="true" property="og:image" content="https://anynines.github.io/img/logo.svg"><meta data-react-helmet="true" property="twitter:image" content="https://anynines.github.io/img/logo.svg"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for Kubernetes Training"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" name="description" content="## Application Access"><meta data-react-helmet="true" property="og:description" content="## Application Access"><meta data-react-helmet="true" property="og:url" content="https://anynines.github.io/kubernetes/80-stateful-sets/stateful-set-application-access">

<link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico">


<link rel="stylesheet" href="/styles.9eb61e8c.css">


<link rel="preload" href="/styles.8d4287d9.js" as="script">

<link rel="preload" href="/runtime~main.b1c49ed2.js" as="script">

<link rel="preload" href="/main.d89959fb.js" as="script">

<link rel="preload" href="/1.074a67c9.js" as="script">

<link rel="preload" href="/1be78505.38c5904c.js" as="script">

<link rel="preload" href="/47.99dc9b04.js" as="script">

<link rel="preload" href="/ec1ed54d.cfa6489d.js" as="script">

<link rel="preload" href="/17896441.93823877.js" as="script">

<link rel="preload" href="/bffcfda2.d173aae9.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/training-overview"><img class="navbar__logo" src="/img/logo.svg" alt="anynines"><strong class="navbar__title">Kubernetes Training</strong></a><a class="navbar__item navbar__link" href="/containerization/container-overview">Container Training</a><a class="navbar__item navbar__link" href="/kubernetes/kubernetes-overview">Kubernetes Training</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://github.com/anynines">GitHub</a><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://paas.anynines.com">anynines PaaS</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/training-overview"><img class="navbar__logo" src="/img/logo.svg" alt="anynines"><strong class="navbar__title">Kubernetes Training</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/containerization/container-overview">Container Training</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/kubernetes-overview">Kubernetes Training</a></li><li class="menu__list-item"><a class="menu__link" target="_blank" rel="noopener noreferrer" href="https://github.com/anynines">GitHub</a></li><li class="menu__list-item"><a class="menu__link" target="_blank" rel="noopener noreferrer" href="https://paas.anynines.com">anynines PaaS</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp"><div class="sidebar_1kLs"><div class="sidebarLogo_3ono"><img src="/img/logo.svg" alt="anynines"><strong>Kubernetes Training</strong></div><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="#!">Introduction</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/training-overview">Kubernetes Training Overview</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="#!">Containerization</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/containerization/container-overview">Container Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/containerization/container-intro">Containers Basics</a></li><li class="menu__list-item"><a class="menu__link" href="#!">Docker</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docker/installation">Docker Installation</a></li><li class="menu__list-item"><a class="menu__link" href="/docker/docker-basics">Docker Basics</a></li><li class="menu__list-item"><a class="menu__link" href="/docker/creating-images">Creating Container Images</a></li><li class="menu__list-item"><a class="menu__link" href="/docker/simple-web-app">Containerizing a Simple Web App</a></li><li class="menu__list-item"><a class="menu__link" href="/docker/publish-image">Publishing a Container Image</a></li><li class="menu__list-item"><a class="menu__link" href="/docker/container-workflow">The Container Workflow</a></li><li class="menu__list-item"><a class="menu__link" href="/docker/docker-cheatsheet">Docker Cheat Sheet</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link" href="#!">Kubernetes</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/kubernetes/kubernetes-overview">Kubernetes Overview</a></li><li class="menu__list-item"><a class="menu__link" href="#!">Basics</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/kubernetes/10-basics/kubectl">kubectl Basics</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/10-basics/namespaces">Namespaces</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/10-basics/container-shell">Container Shell Access</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="#!">Pods</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/kubernetes/20-pods/introduction">Pods</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="#!">ReplicaSets and Services</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/kubernetes/40-replicaset-and-service/introduction">ReplicaSets and Services</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/40-replicaset-and-service/replicasets">ReplicaSets</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/40-replicaset-and-service/services">Services</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/40-replicaset-and-service/ingress">Ingress</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/40-replicaset-and-service/tidyup">Tyding Up</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="#!">Deployments</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/kubernetes/50-deployments/deployments">Deployments</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="#!">ConfigMaps and Secrets</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/kubernetes/60-configmaps-and-secrets/configmaps-and-secrets">ConfigMaps and Secrets</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/60-configmaps-and-secrets/configmaps">ConfigMaps</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/60-configmaps-and-secrets/exercise-explanation">Exercise Explanation</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/60-configmaps-and-secrets/configmaps-volume-mounts">ConfigMap Volume Mounts</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/60-configmaps-and-secrets/secrets">Secrets</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/60-configmaps-and-secrets/secrets-exercise-explanation">Secrets Exercise Explanation</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="#!">Jobs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/kubernetes/70-jobs/jobs">Jobs</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/70-jobs/advanced-jobs">Advanced Job Features</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/70-jobs/parallel-jobs">Parallel Jobs</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/70-jobs/cron-jobs">CronJobs</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="#!">StatefulSets</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/kubernetes/80-stateful-sets/persistent-volumes">Persistent Volumes</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/80-stateful-sets/persistent-volumes-exercise">Persistent Volumes Excercise</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/80-stateful-sets/stateful-sets">StatefulSets</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/80-stateful-sets/stateful-set-postgresql">PostgreSQL StatefulSet</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/80-stateful-sets/stateful-set-headless-service">Headless Service</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/80-stateful-sets/stateful-set-vs-replicasets">StatefulSet vs. ReplicaSets</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/80-stateful-sets/stateful-set-psql-access-to-postgresql">PSQL Access to PostgreSQL</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/kubernetes/80-stateful-sets/stateful-set-application-access">Application Access to a StatefulSet</a></li><li class="menu__list-item"><a class="menu__link" href="/kubernetes/80-stateful-sets/stateful-set-conclusions">Conclusions</a></li></ul></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="padding-vert--lg"><div class="container"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">Application Access to a StatefulSet</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="application-access"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#application-access" title="Direct link to heading">#</a>Application Access</h2><p>After setting up the database and connecting to it using the <code>psql</code> utility, the next step is to access the database with an application running on Kubernetes.</p><p>At this point we should rember that Kubernetes is not a fully featured platform but rather platform for building platforms [4]. So in contrast to technologies such as Cloud Foundry [5] there is no such thing as a Service Binding as defined in the Open Service Broker API [6] where application developers can bind apps to service instances such as PostgreSQL with a single command. This will then create a dedicated database user which will be deleted if the application is unbound from the service. This requires a so called Service Broker such as implemented by the a9s Data Services [7] which can then be integrated with Cloud Foundry and Kubernetes. The integration of Service Brokers with Kubernetes requires the Service Catalog extension [8]. However, this lesson is about core Kubernetes so Service Bindings won&#x27;t be covered in detail. </p><p>With the absense of Service Bindings we fall back to using Kubernetes Secrets as covered in earlier chapters. Hence, with a bare Kubernetes it is up to the user to manage Secrets to grand and/or revoke access to StatefulSets.</p><p>You may ask yourself <strong>why not use the existing <code>postgres</code> user</strong>?</p><p>In non-production applications - where security is not a concern - using the <code>postgresql</code> is possible. However, for production grade applications, it makes sense to stick to the <em>least privilege principle</em> [9]. According to this principle, the application user should be limited to the minimum set of privileges necesseary to carry out the application&#x27;s tasks. Consequently, an application user should not be granted admin privileges unless absolutely necessary.
Another major drawback of using shared credentials among users is that the credentials have to be changed if a user is removed. Think about a team member who knew the <code>postgresql</code> password and then left the team. In order to secure access to the database, the password needs to be changed. If the password is used by ten other users including application machine users, the effort for updating the password is highly wasteful.
With a dedicated set of credentials - a database username and password - per user is therefore much simpler. It allows revoking access or modifying privileges on a per user level easily.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="example"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#example" title="Direct link to heading">#</a>Example</h2><p>In this example you will create a another Secret, deploy a simple application and gran the application access to the PostgreSQL StatefulSet.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="the-example-application"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#the-example-application" title="Direct link to heading">#</a>The Example Application</h3><p>The example uses a very <a href="https://golang.org/">simple web app [1]</a> written in Go [2]. The corresponding container image can be found on <a href="https://hub.docker.com/repository/docker/fischerjulian/smpl-go-pg">DockerHub [3]</a>.</p><p>The app is not meant to show state-of-the-art Go code and is soley used for didactic purposes of this training.</p><p>The container image can be referenced from a Pod definition as:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">fischerjulian/smpl-go-pg:0.2.0</span></div></code></pre></div><p>Even without knowledge of the Go language, it is easy to identify the section in the <a href="https://github.com/fischerjulian/smpl-go-pg/blob/master/main.go">source code</a> reading the access credentials.</p><p>The relevant part of the application is the following:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-go codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">postgresUsername </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">Getenv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;POSTGRES_USERNAME&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">postgresPassword </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">Getenv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;POSTGRES_PASSWORD&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">postgresHost </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">Getenv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;POSTGRES_HOST&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">connStr </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;user=&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> postgresUsername </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot; dbname=postgres sslmode=disable password=&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> postgresPassword </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot; host=&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> postgresHost</span></div></code></pre></div><p>This reads the environment variables <code>POSTGRES_USERNAME</code>, <code>POSTGRES_PASSWORD</code> and <code>POSTGRES_HOST</code>. </p><p>We do not plan to share the PostgreSQL instance so hardcoding the database name <code>postgresql</code> is ok, at least for this example.</p><p>Be aware that using environment variables has the drawback that the application needs to be re-deployed in order to update the environment variables, in case the Secret is being changed. As mentioned in an earlier lesson, the alternative would be to mount the Secret as a file and let the application re-read it from time to time. For this example, environment variables will do the trick.</p><p>In order to keep the application independent from a particular instance of the PostgreSQL StatefulSet we need a Secret consisting of the following elements:</p><ul><li>Username</li><li>Password</li><li>Hostname</li></ul><p>The username and password can be created along with the Secret. </p><p>As this is a machine user, using a cryptic username makes it harder to guess and the application doesn&#x27;t care about the password complexity.</p><table><thead><tr><th>Username</th><th>Password</th></tr></thead><tbody><tr><td>gaeMo6di</td><td>UaGu5chu</td></tr></tbody></table><p>The hostname is determined by the headless Service you have created earlier.</p><p>The dns hostname of the Service <code>postgresql-svc</code> in the Namespace <code>k8s-training</code> for a Kubernetes cluster with the cluster domain <code>cluster.local</code> is then:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">postgresql-svc.k8s-training.svc.cluster.local</span></div></code></pre></div><p>In order to bring the username and password to life, you need to create a database user.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="creating-the-database-user"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#creating-the-database-user" title="Direct link to heading">#</a>Creating the Database User</h3><p>In the previous lesson, you have used a separate Pod to connect to the PostgreSQL database to demontrate a remote access. In this case, all you want is to create a database user. The easier way to get to the database is to <strong>start a shell directly on the database Pod</strong>:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl exec -it postgresql-sfs-0 -- bash</span></div></code></pre></div><p>Now, you are within the data service Pod and have access to PostgreSQL command line utilities such as <code>createuser</code>.</p><p>To get more information on which parameters need to passed to the command execute:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">createuser --help</span></div></code></pre></div><p>The command pattern is:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">createuser [OPTION]... [ROLENAME]</span></div></code></pre></div><p>Which leads to the following command:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">createuser --username=postgres -W gaeMo6di -P</span></div></code></pre></div><p>This needs explanation. </p><p>The <code>--username=postgres</code> option is to authenticate the <code>createuser</code> command. You don&#x27;t want anybody with shell access to create users and therefore authentication is necessary. The <code>postgres</code> user has sufficient rights to create new users.
The <code>-W</code> makes <code>psql</code> prompt for the password to authenticate the <code>postgresql</code> user. Use the <code>tes6Aev8</code> password - or your version of it - that you used during the creation of the PostgreSQL StatefulSet.</p><p>Then the <code>gaeMo6di</code> is the <code>[ROLENAME]</code> from the command pattern describe above. It&#x27;s a bit confusing as you may read <code>-W gaeMo6di</code> as if <code>gaeMo6di</code> is an argument to the option <code>-W</code> but this is a false friend. <code>-W</code> is an option and <code>gaeMo6di</code> a stand-alone argument.
Finally, the <code>-P</code> makes the <code>createuser</code> command prompt for the password of the <code>gaeMo6di</code> user. Use the password <code>UaGu5chu</code> - or your alternative for it.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="grand-the-new-user-acces-privileges"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#grand-the-new-user-acces-privileges" title="Direct link to heading">#</a>Grand the New User Acces Privileges</h3><p>Now, there is a user <code>gaeMo6di</code> but it is lacking of appropriate access privileges. If you try to access the <code>postgres</code> database, you&#x27;ll see an error message such as:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">permission denied for table user </span></div></code></pre></div><p>Therefore, you need to grand the user <code>gaeMo6di</code> privileges to access the <code>postgres</code> database which can be done using <code>psql</code>.</p><p>Execute:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">psql -U postgresql</span></div></code></pre></div><p>Execute the following SQL commands:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">GRANT ALL PRIVILEGES ON DATABASE &quot;postgres&quot; to &quot;gaeMo6di&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA &quot;public&quot; TO &quot;gaeMo6di&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA &quot;public&quot; TO &quot;gaeMo6di&quot;;</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="testing-the-user-access"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#testing-the-user-access" title="Direct link to heading">#</a>Testing the User Access</h3><p>Note that, with the default config of PostgreSQL, using <code>psql</code> locally to verify the created user is pointless as PostgreSQL does not require a password authentication and trusts anybody connecting from <code>localhost</code>. This setting is not safe for productive use and means that you can&#x27;t verify your password with it.</p><p>So to test the credentials we need a remote Pod:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl run pg-psql -i --tty --image=postgres:12.2 --restart=Never --env=&quot;PGPASSWORD=UaGu5chu&quot; -- psql -h postgresql-svc.k8s-training.svc.cluster.local -U gaeMo6di -d postgres</span></div></code></pre></div><p>You should see a <code>psql</code> prompt similar to:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">postgres=&gt; SELECT * FROM COMPANY;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> id |     name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">----+---------------</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  1 | anynines GmbH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(1 row)</span></div></code></pre></div><p>Done.</p><p>Ok, now that you have collected all pieces of information necessary, you can proceed with creating the Secret.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="creating-the-application-secret"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#creating-the-application-secret" title="Direct link to heading">#</a>Creating the Application Secret</h3><p>First, create a separate Secret. As this is an additional Secret a unique name is required: <code>postgresql-secret-2</code>. </p><p>You can see where this is going if a large number of StatefulSets and a large number of users is necessary. You will have to manage many Secrets.</p><p>To create the Secret <code>postgresql-secret-2</code> execute:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl create secret generic postgresql-secret-2 \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --from-literal=POSTGRES_HOST=postgresql-svc.k8s-training.svc.cluster.local \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --from-literal=POSTGRES_USERNAME=gaeMo6di \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --from-literal=POSTGRES_PASSWORD=UaGu5chu</span></div></code></pre></div><p>This creates three keys provided as literals corresponding to the aforementioned credentials.</p><p>Verify your Secret with:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl describe secret postgresql-secret-2</span></div></code></pre></div><p>Check whether the desired key-value-pairs have been created:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Name:         postgresql-secret-2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Namespace:    k8s-training</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Labels:       &lt;none&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Annotations:  &lt;none&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Type:  Opaque</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Data</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">====</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">POSTGRES_PASSWORD:  8 bytes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">POSTGRES_USERNAME:  8 bytes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">POSTGRES_HOST:      45 bytes</span></div></code></pre></div><p>With the Secret being ready, it&#x27;s time to think about the application deployment.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="deploying-the-application"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#deploying-the-application" title="Direct link to heading">#</a>Deploying the Application</h3><p>Before thinking about more complex structures such as ReplicaSets or StatefulSets, you can start with a simple Pod.
This will allow you to focus on mounting the Secret into the Pod. The idea is to start simple and take little steps. This keeps frustration low. Solving each little challenge also provides a little reward. Later if you are well practices, these little steps may become wasteful and larget steps become more economic.</p><p>In order to get the Secrets into the Pod you can use the Secret example from an early chapter which you will then modify incrementally.</p><p>This is the Secret example from the earlier lesson:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-yaml codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Pod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> busybox</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">secrets</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> busybox</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> busybox</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">secrets</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">container</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;env&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> USERNAME</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> area51</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> username</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> PASSWORD</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> area51</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> password</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Never</span></div></code></pre></div><p>Create a file <code>40-postgressql-application.yaml</code>, paste the example from above and modify its content by performing the following steps:</p><ol><li>Choose a name for the Pod such as <code>postgresql-application</code> and name the container respectively.</li><li>Adapt the name of the Secret from <code>area51</code> to <code>postgresql-secret-2</code>.</li><li>Copy one of the elements of the <code>env</code> array to define an additional environment variable.</li><li>Change the <code>name</code> attributes to match the env variable names and the <code>key</code> attributes to match the name of the keys in the corresponding Secrets. In this case the name for both the env variable <code>name</code> and the Secret <code>key</code> are identical.</li><li>Change the container image from <code>busybox</code> to <code>fischerjulian/smpl-go-pg:0.2.0</code>.</li><li>Remove the <code>command</code> section. The container image already defines a meaningful startup command.</li><li>Change the <code>restartPolicy</code> to <code>Always</code> as we want the web app to restart in case of a container failure.</li></ol><p>The modified result looks like the following:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-yaml codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Pod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">application</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> fischerjulian/smpl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">go</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">pg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">0.2.0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">application</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">container</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_USERNAME</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">secret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_USERNAME</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_PASSWORD</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">secret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_PASSWORD</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_HOST</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">secret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_HOST</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">containerPort</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> http</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Always</span></div></code></pre></div><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl apply -f pgapp.yaml</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="application-service"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#application-service" title="Direct link to heading">#</a>Application Service</h3><p>As we have seen in earlier lessons it is useful to have a Service in front of an application. This will provide a stable network entry point in form of a DNS name as well as an IP address. Also it will enable a load balancing if further Pods will be added.</p><p>Create a file <code>50-pg-app-svc.yaml</code> with the following content:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-yaml codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> pg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">svc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">port</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">app</span></div></code></pre></div><p>Start the <code>kubectl proxy</code>:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl proxy</span></div></code></pre></div><p>And access the web application by browsing to the URL:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">http://localhost:8001/api/v1/namespaces/k8s-training/services/http:pg-app-svc:8080/proxy/</span></div></code></pre></div><p>Alternatively, you can use an auxiliary Pod to execute a <code>curl</code> command to issue an HTTP request to the app:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl run -i --tty nspct --image=fischerjulian/nspct --restart=Never -- bash</span></div></code></pre></div><p>Once withing the Pod, you can verify that all necessary Services resolve:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">nslookup pg-app-svc.k8s-training.svc.cluster.local</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">nslookup postgresql-svc.k8s-training.svc.cluster.local</span></div></code></pre></div><p>And issue the HTTP request:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">curl localhost:8080</span></div></code></pre></div><p>Which should return something like:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;h1&gt;Simple PostgreSQL Web App&lt;/h1&gt;&lt;h2&gt;Company: anynines GmbH&lt;h2&gt;</span></div></code></pre></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="exercise"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#exercise" title="Direct link to heading">#</a>Exercise</h2><p>Based on the Pod specification for the <code>postgres-application</code> perform the following steps:</p><ol><li>Create a ReplicaSet with <code>replicas: 1</code>.</li><li>Set <code>replicas: 3</code>.</li><li>Create a Deployment.</li></ol><p>The ReplicaSet will replace your Pod. The Deployment will replace your ReplicaSet. So before creating the ReplicaSet delete the <code>postgresql-application</code> Pod. Let your ReplicaSet create it. Then delete your ReplicaSet and create a Deployment that will create your ReplicaSet and Pods.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="links"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#links" title="Direct link to heading">#</a>Links</h2><ol><li>Simple Go PostgreSQL Application, Julian Fischer @ Github, <a href="https://github.com/fischerjulian/smpl-go-pg">https://github.com/fischerjulian/smpl-go-pg</a></li><li>Golang, <a href="https://golang.org/">https://golang.org/</a></li><li>Simple Go PostgreSQL Application Container Image, Julian Fischer @ dockerhub, <a href="https://hub.docker.com/repository/docker/fischerjulian/smpl-go-pg">https://hub.docker.com/repository/docker/fischerjulian/smpl-go-pg</a></li></ol></div></article><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/kubernetes/80-stateful-sets/stateful-set-psql-access-to-postgresql"><h5 class="pagination-nav__link--sublabel">Previous</h5><h4 class="pagination-nav__link--label">« PSQL Access to PostgreSQL</h4></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/kubernetes/80-stateful-sets/stateful-set-conclusions"><h5 class="pagination-nav__link--sublabel">Next</h5><h4 class="pagination-nav__link--label">Conclusions »</h4></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="contents contents__left-border"><li><a href="#application-access" class="contents__link">Application Access</a></li><li><a href="#example" class="contents__link">Example</a><ul><li><a href="#the-example-application" class="contents__link">The Example Application</a></li><li><a href="#creating-the-database-user" class="contents__link">Creating the Database User</a></li><li><a href="#grand-the-new-user-acces-privileges" class="contents__link">Grand the New User Acces Privileges</a></li><li><a href="#testing-the-user-access" class="contents__link">Testing the User Access</a></li><li><a href="#creating-the-application-secret" class="contents__link">Creating the Application Secret</a></li><li><a href="#deploying-the-application" class="contents__link">Deploying the Application</a></li><li><a href="#application-service" class="contents__link">Application Service</a></li></ul></li><li><a href="#exercise" class="contents__link">Exercise</a></li><li><a href="#links" class="contents__link">Links</a></li></ul></div></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">More from anynines</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" to="https://anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" href="https://anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web">anynines.com</a></li><li class="footer__item"><a class="footer__link-item" to="https://paas.anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" href="https://paas.anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web">anynines PaaS</a></li><li class="footer__item"><a class="footer__link-item" to="https://anynines.com/jobs/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" href="https://anynines.com/jobs/?utm_source=k8s-tutorial&amp;utm_medium=web">Jobs at anynines</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Follow us</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" to="https://twitter.com/anynines" target="_blank" href="https://twitter.com/anynines">Twitter</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.linkedin.com/company/anynines/" target="_blank" href="https://www.linkedin.com/company/anynines/">LinkedIn</a></li><li class="footer__item"><a class="footer__link-item" to="https://instagram.com/anyninescom" target="_blank" href="https://instagram.com/anyninescom">Instagram</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" to="https://www.anynines.com/imprint" target="_blank" href="https://www.anynines.com/imprint">Imprint</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.anynines.com/data-privacy" target="_blank" href="https://www.anynines.com/data-privacy">Privacy Policy</a></li></ul></div></div><div class="text--center"><div>Copyright © 2020 anynines GmbH.</div></div></div></footer>
</div>

<script src="/styles.8d4287d9.js"></script>

<script src="/runtime~main.b1c49ed2.js"></script>

<script src="/main.d89959fb.js"></script>

<script src="/1.074a67c9.js"></script>

<script src="/1be78505.38c5904c.js"></script>

<script src="/47.99dc9b04.js"></script>

<script src="/ec1ed54d.cfa6489d.js"></script>

<script src="/17896441.93823877.js"></script>

<script src="/bffcfda2.d173aae9.js"></script>


</body>
</html>