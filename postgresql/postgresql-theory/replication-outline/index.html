<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<title data-react-helmet="true">Replication Outline | Kubernetes Training</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://learn.kubernetes.anynines.com/img/logo.svg"><meta data-react-helmet="true" name="twitter:image" content="https://learn.kubernetes.anynines.com/img/logo.svg"><meta data-react-helmet="true" property="og:url" content="https://learn.kubernetes.anynines.com/postgresql/postgresql-theory/replication-outline"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Replication Outline | Kubernetes Training"><meta data-react-helmet="true" name="description" content="Before looking into how a highly available PostgreSQL using streaming replication is build, let&#x27;s draw an outline of what is to be achieved. Then in subsequent sections the design goals will be iteratively approximated."><meta data-react-helmet="true" property="og:description" content="Before looking into how a highly available PostgreSQL using streaming replication is build, let&#x27;s draw an outline of what is to be achieved. Then in subsequent sections the design goals will be iteratively approximated."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://learn.kubernetes.anynines.com/postgresql/postgresql-theory/replication-outline"><link data-react-helmet="true" rel="alternate" href="https://learn.kubernetes.anynines.com/postgresql/postgresql-theory/replication-outline" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://learn.kubernetes.anynines.com/postgresql/postgresql-theory/replication-outline" hreflang="x-default"><script data-react-helmet="true" id="oil-configuration" type="application/configuration">
          {
            "config_version": 1,
            "publicPath": "/",
            "advanced_settings": true,
            "default_to_optin": true,
            "gdpr_applies_globally": true,
            "timeout": -1,
            "local_url": "/oils-de.json",
            "iabVendorListUrl": "/vendorlist.json",
            "customVendorListUrl": "/vendors.json",
          }
        </script><script data-react-helmet="true" src="/oilstub.1.3.5-SNAPSHOT.min.js"></script><script data-react-helmet="true" src="/oil.1.3.5-SNAPSHOT.min.js"></script><link rel="stylesheet" href="/assets/css/styles.f7ace848.css">
<link rel="preload" href="/assets/js/runtime~main.f5a8c1d1.js" as="script">
<link rel="preload" href="/assets/js/main.7e346184.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/training-overview"><img src="/img/logoLight.svg" alt="anynines" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="anynines" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Kubernetes Training</b></a><a class="navbar__item navbar__link" href="/containerization/container-overview">Container Training</a><a class="navbar__item navbar__link" href="/kubernetes/kubernetes-overview">Kubernetes Training</a><a class="navbar__item navbar__link" href="/postgresql/postgresql-overview">PostgreSQL on Kubernetes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/anynines/a9s-kubernetes-training" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Fork me<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/anynines" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://paas.anynines.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>anynines PaaS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Introduction</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Containerization</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Kubernetes</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">PostgreSQL on Kubernetes</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-overview">Overview</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">PostgreSQL Replication</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-theory/why-use-replication">Why use Replication?</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/postgresql/postgresql-theory/replication-outline">Replication Outline</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-theory/streaming-replication">PostgreSQL Streaming Replication</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-theory/setting-up-streaming-replication">Setting up Streaming Replication</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">StatefulSet with Replication</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-outro">Outro</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Replication Outline</h1></header><p>Before looking into <strong>how</strong> a highly available PostgreSQL using streaming replication is build, let&#x27;s draw an outline of <strong>what</strong> is to be achieved. Then in subsequent sections the design goals will be iteratively approximated.</p><p>In the remainder of this training the focus will be to create an asynchronous streaming replication with PostgreSQL. This will lead to certain characteristics and challenges.</p><p>Let&#x27;s assume a cluster consisting of three (3) PostgreSQL replicas in a StatefulSet setup with asynchronous streaming replication.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="primary-and-secondary-postgresql-servers"></a>Primary and Secondary PostgreSQL Servers<a class="hash-link" href="#primary-and-secondary-postgresql-servers" title="Direct link to heading">#</a></h2><p>In PostgreSQL there is no client awareness that replication is used. When configuring an application to connect to a PostgreSQL server, server credentials have to be provided. These credentials usually include the <strong>hostname</strong>, username, password, port and other configuration options.</p><p><strong>Only a single hostname pointing to a single PostgreSQL server can be supplied to a standard PostgreSQL client</strong>.</p><p>Per default, all write and read requests will be issued against this particular server. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="asynchronous-replication"></a>Asynchronous Replication<a class="hash-link" href="#asynchronous-replication" title="Direct link to heading">#</a></h2><p>With <em>asynchronous</em> replication changes made to a PostgreSQL&#x27;s dataset are replicated <strong>after</strong> the actual transaction.</p><p>Let&#x27;s assume an application inserts a record into a table. At the exact moment the transaction has been committed only the server accepting the incoming SQL statement reflects the change. None of the two other PostgreSQL servers in the StatefulSet will take notice, instantly. It takes a bit for them to retrieve changes.</p><p>If asynchronous streaming replication is set up properly, the remaining servers will retrieve changes made to their peer and store them locally. The time delay in which the servers are out of sync is called <strong>replication lag</strong>. In case of a failure this data - lagging behind - would be lost.</p><p>As asynchronous streaming replication in PostgreSQL means applying data changes of a particular server to a number of other servers which act as <em>followers</em> a clear topology is established. The server receiving all read and write requests is called the <strong>Primary</strong> and its followers are called <strong>Secondaries</strong>. Other terminologies use <strong>Leader &amp; Followers</strong> and (obsolete) <strong>Master and Slaves</strong>.</p><p>The simplest approach is to determine the roles of primary and secondary servers statically. However, in a failure scenario it would be desirable to have <strong>automatic failure detection</strong>, <strong>leader election</strong> and <strong>leader promotion</strong>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="automatic-failure-detection"></a>Automatic Failure Detection<a class="hash-link" href="#automatic-failure-detection" title="Direct link to heading">#</a></h2><p>Detecting a failure in a distributed system is a non-trivial problem which can be traced by to the well known Byzantine Generals Problem [1]. Overly simplifying, it is hard to distinguish between a failed server and a failing network connection.</p><p>Consider a simple scenario where the Primary server has failed due to the failure of the underlying infrastructure availability zone. In this scenario, the failed Primary is down and will stay down. No other Pod can replace it as the entire availability zone is affected.
In such as case a surviving Secondary pod could detect that the Primary is missing and initiate a leader election. But how can the Secondary be sure that the Primary is really down and distinguish this scenario from the scenario where only the Secondary can&#x27;t reach the Primary? In the latter case, a falsely triggered leader election could do harm. The worst case would be to have multiple Primaries receiving incoming requests resulting into data inconsistencies which cannot be resolved automatically.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="consensus-and-leader-election"></a>Consensus and Leader Election<a class="hash-link" href="#consensus-and-leader-election" title="Direct link to heading">#</a></h2><p>In distributed systems engineering the solution to the Byzantine Generals Problems is sometimes referred to as <strong>consensus algorithms</strong>. Without going too much into details two algorithms dominate the scene: <em>Paxos</em> and <em>RAFT</em> [2]. The essence here is: a cluster requires an odd number of nodes (3, 5, ...) to reach consensus by forming a quorum - imagine it as a majority vote.</p><p>Implementations of consensus algorithms are all over the place. Kubernetes itself, etcd, Zookeeper and the alike are all equipped with them.</p><p>With an implementation of a consensus algorithm at hand, being certain of a failed node and forming a quorum to elect a new leader is possible.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="leader-promotion"></a>Leader Promotion<a class="hash-link" href="#leader-promotion" title="Direct link to heading">#</a></h2><p>Once a leader has been elected, it also has to be promoted. In technical terms: during leader promotion it is ensured that database clients will exclusively connect to the newly promoted Primary. Not to the old Primary (which may still be around) and not to any of the Secondaries.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>As you can see: things get complicated quickly. Therefore, following the <em>divide and conquer</em> paradigm, the PostgreSQL replication endeavor is split into manageable steps.</p><p>In the next step, you&#x27;ll look into how replication works with PostgreSQL and <strong>the first milestone is to set up a static three node Primary / Secondary StatefulSet</strong> that will replicate changes to the Primary to all its Secondaries.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="links-and-sources"></a>Links and Sources<a class="hash-link" href="#links-and-sources" title="Direct link to heading">#</a></h2><ol><li>Wikipedia, Byzantine Fault, <a href="https://en.wikipedia.org/wiki/Byzantine_fault" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Byzantine_fault</a></li><li>Cornell University, Paxos vs Raft: Have we reached consensus on distributed consensus?, Heidi Howard, Richard Mortier
, <a href="https://arxiv.org/abs/2004.05074" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2004.05074</a></li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/postgresql/postgresql-theory/why-use-replication"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Why use Replication?</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/postgresql/postgresql-theory/streaming-replication"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">PostgreSQL Streaming Replication Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#primary-and-secondary-postgresql-servers" class="table-of-contents__link">Primary and Secondary PostgreSQL Servers</a></li><li><a href="#asynchronous-replication" class="table-of-contents__link">Asynchronous Replication</a></li><li><a href="#automatic-failure-detection" class="table-of-contents__link">Automatic Failure Detection</a></li><li><a href="#consensus-and-leader-election" class="table-of-contents__link">Consensus and Leader Election</a></li><li><a href="#leader-promotion" class="table-of-contents__link">Leader Promotion</a></li><li><a href="#summary" class="table-of-contents__link">Summary</a></li><li><a href="#links-and-sources" class="table-of-contents__link">Links and Sources</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">More from anynines</h4><ul class="footer__items"><li class="footer__item"><a href="https://anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" rel="noopener noreferrer" class="footer__link-item">anynines.com</a></li><li class="footer__item"><a href="https://paas.anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" rel="noopener noreferrer" class="footer__link-item">anynines PaaS</a></li><li class="footer__item"><a href="https://anynines.com/jobs/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" rel="noopener noreferrer" class="footer__link-item">Jobs at anynines</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Follow us</h4><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/anynines" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://www.linkedin.com/company/anynines/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn</a></li><li class="footer__item"><a href="https://instagram.com/anyninescom" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.anynines.com/imprint" target="_blank" rel="noopener noreferrer" class="footer__link-item">Imprint</a></li><li class="footer__item"><a href="https://www.anynines.com/data-privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2022 anynines GmbH.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.f5a8c1d1.js"></script>
<script src="/assets/js/main.7e346184.js"></script>
</body>
</html>