<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<title data-react-helmet="true">Setting up Streaming Replication | Kubernetes Training</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://anynines.github.io/a9s-kubernetes-training//img/logo.svg"><meta data-react-helmet="true" name="twitter:image" content="https://anynines.github.io/a9s-kubernetes-training//img/logo.svg"><meta data-react-helmet="true" property="og:url" content="https://anynines.github.io/a9s-kubernetes-training//postgresql/postgresql-theory/setting-up-streaming-replication"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Setting up Streaming Replication | Kubernetes Training"><meta data-react-helmet="true" name="description" content="Now that it has been decided which replication type to use and that you have learned how it works, it&#x27;s time to investigate how streaming replication is configured."><meta data-react-helmet="true" property="og:description" content="Now that it has been decided which replication type to use and that you have learned how it works, it&#x27;s time to investigate how streaming replication is configured."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://anynines.github.io/a9s-kubernetes-training//postgresql/postgresql-theory/setting-up-streaming-replication"><link data-react-helmet="true" rel="alternate" href="https://anynines.github.io/a9s-kubernetes-training//postgresql/postgresql-theory/setting-up-streaming-replication" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://anynines.github.io/a9s-kubernetes-training//postgresql/postgresql-theory/setting-up-streaming-replication" hreflang="x-default"><script data-react-helmet="true" id="oil-configuration" type="application/configuration">
          {
            "config_version": 1,
            "publicPath": "/js",
            "advanced_settings": true,
            "default_to_optin": true,
            "gdpr_applies_globally": true,
            "timeout": -1,
            "local_url": "/oils-de.json",
            "iabVendorListUrl": "/vendorlist.json",
            "customVendorListUrl": "/vendors.json",
          }
        </script><script data-react-helmet="true" src="/oilstub.1.3.5-SNAPSHOT.min.js"></script><script data-react-helmet="true" src="/oil.1.3.5-SNAPSHOT.min.js"></script><link rel="stylesheet" href="/assets/css/styles.2dadb555.css">
<link rel="preload" href="/assets/js/runtime~main.c175611c.js" as="script">
<link rel="preload" href="/assets/js/main.4c268502.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/training-overview"><img src="/img/logo.svg" alt="anynines" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="anynines" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Kubernetes Training</b></a><a class="navbar__item navbar__link" href="/containerization/container-overview">Container Training</a><a class="navbar__item navbar__link" href="/kubernetes/kubernetes-overview">Kubernetes Training</a><a class="navbar__item navbar__link" href="/postgresql/postgresql-overview">PostgreSQL on Kubernetes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/anynines" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://paas.anynines.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>anynines PaaS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_1J2g">Introduction</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/training-overview">Kubernetes Training Overview</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_1J2g">Containerization</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/containerization/container-overview">Container Overview</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/containerization/container-intro">Containers Basics</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_1J2g" tabindex="0">Docker</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docker/installation">Docker Installation</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docker/docker-basics">Docker Basics</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docker/creating-images">Creating Container Images</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docker/simple-web-app">Containerizing a Simple Web App</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docker/publish-image">Publishing a Container Image</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docker/container-workflow">The Container Workflow</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docker/docker-cheatsheet">Docker Cheat Sheet</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_1J2g">Kubernetes</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/kubernetes-overview">Kubernetes Overview</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_1J2g" tabindex="0">Basics</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/basics/kubectl">kubectl Basics</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/basics/namespaces">Namespaces</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/basics/container-shell">Container Shell Access</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_1J2g" tabindex="0">Pods</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/pods/introduction">Pods</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_1J2g" tabindex="0">ReplicaSets and Services</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/replicaset-and-service/introduction">ReplicaSets and Services</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/replicaset-and-service/replicasets">ReplicaSets</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/replicaset-and-service/services">Services</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/replicaset-and-service/ingress">Ingress</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/replicaset-and-service/tidyup">Tyding Up</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_1J2g" tabindex="0">Deployments</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/deployments/deployments">Deployments</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_1J2g" tabindex="0">ConfigMaps and Secrets</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/configmaps-and-secrets/configmaps-and-secrets">ConfigMaps and Secrets</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/configmaps-and-secrets/configmaps">ConfigMaps</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/configmaps-and-secrets/exercise-explanation">Exercise Explanation</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/configmaps-and-secrets/configmaps-volume-mounts">ConfigMap Volume Mounts</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/configmaps-and-secrets/secrets">Secrets</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/configmaps-and-secrets/secrets-exercise-explanation">Secrets Exercise Explanation</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_1J2g" tabindex="0">Jobs</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/jobs/jobs">Jobs</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/jobs/advanced-jobs">Advanced Job Features</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/jobs/parallel-jobs">Parallel Jobs</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/jobs/cron-jobs">CronJobs</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_1J2g" tabindex="0">StatefulSets</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/stateful-sets/persistent-volumes">Persistent Volumes</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/stateful-sets/persistent-volumes-exercise">Persistent Volumes Excercise</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/stateful-sets/stateful-sets">StatefulSets</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/stateful-sets/stateful-set-postgresql">PostgreSQL StatefulSet</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/stateful-sets/stateful-set-headless-service">Headless Service</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/stateful-sets/stateful-set-vs-replicasets">StatefulSet vs. ReplicaSets</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/stateful-sets/stateful-set-psql-access-to-postgresql">PSQL Access to PostgreSQL</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/stateful-sets/stateful-set-application-access">Application Access to a StatefulSet</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/stateful-sets/stateful-set-conclusions">Conclusions</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_1J2g">PostgreSQL on Kubernetes</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-overview">Overview</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_1J2g" tabindex="0">PostgreSQL Replication</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-theory/why-use-replication">Why use Replication?</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-theory/replication-outline">Replication Outline</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-theory/streaming-replication">PostgreSQL Streaming Replication</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/postgresql/postgresql-theory/setting-up-streaming-replication">Setting up Streaming Replication</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_1J2g" tabindex="0">StatefulSet with Replication</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/stateful-sets-revisited/stateful-sets-revisited">StatefulSets Revisited</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/building-the-pg-stateful-set/pg-service-primary">Service to Connnect to the Primary</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/building-the-pg-stateful-set/streaming-replication-configmaps">Streaming Replication ConfigMaps</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/building-the-pg-stateful-set/streaming-replication-sfs-init">Initializing the StatefulSet</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/building-the-pg-stateful-set/replication-user">Creating a Replication User</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/building-the-pg-stateful-set/verify-replication">Verifying the Replication</a></li></ul></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-outro">Outro</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Setting up Streaming Replication</h1></header><p>Now that it has been decided which replication type to use and that you have learned how it works, it&#x27;s time to investigate how streaming replication is configured.</p><p>As a general advice for data service automation, it is wise to understand the operational first, before diving into writing automation code.</p><p>Therefore, before diving into the depths of Kubernetes automation it makes to understand how a manual configuration of PostgreSQL streaming replication works. In other words, we need to understand what a database administrator would do before we can automate his work. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="setting-up-streaming-replication"></a>Setting up Streaming Replication<a class="hash-link" href="#setting-up-streaming-replication" title="Direct link to heading">#</a></h2><p>The PostgreSQL documentation [1] explains how streaming replication can be configured. </p><p>The configuration procedure is similar to setting up a file-based log shipping. Remember that <em>write-ahead log shipping</em> transfers entire WAL files (containing many WAL records) while streaming replication continously ships WAL records.</p><p>The configuration step on a secondary that switches from <em>log shipping</em> to streaming replication is setting the <code>primary_conninfo</code> setting to point to the primary server.</p><p>This will tell PostgreSQL on the secondary to connect to the primary to retrieve WAL records. In order for this to work, <strong>the primary PostgreSQL must be configured to authenticate incoming replication requests from secondaries</strong>.</p><p>To make the primary ready, the <code>listen_addresses</code> must be set so that PostgreSQL will bind to the right network interface and not only to <code>localhost</code>. This ensures that secondaries can establish socket connections to the primary PostgreSQL. </p><p>This can be achieved by modifying the <code>postgresql.conf</code> similar to this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly conf"><pre tabindex="0" class="prism-code language-conf codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain"># Possible values are replica|minimal|logical</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">wal_level = replica</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># required for pg_rewind capability when standby goes out of sync with master</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">wal_log_hints = on</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># sets the maximum number of concurrent connections from the standby servers.</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">max_wal_senders = 3</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># The below parameter is used to tell the master to keep the minimum number of segments of WAL logs so that they are not deleted before standby consumes them. Each segment is 16MB.</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">wal_keep_segments = 8</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># The below parameter enables read only connection on the node when it is in standby role. This is ignored when the server is running as master.</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">hot_standby = on</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Furthermore, the primary must successfully authenticate these incoming network connections. <strong>As streaming replication requests are implemented as PostgreSQL connections, it is necessary to create a replication user with appropriate access privileges</strong>.</p><p>Once the <code>primary_conninfo</code> is set, secondaries when starting will first replay all WAL files available in there archive and then connect to the primary. After a successful start of a secondary the process list will show a <code>walreceiver</code> process:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">postgres    </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">15</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> Jun22 ?        00:02:21 postgres: walreceiver   streamin</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>There are more details to a production grade configuration such as:</p><ul><li>Ensuring WAL segements are kept on the primary long enough so that secondaries can retrieve them.</li><li>Ensuring that <code>max_wal_senders</code> is set appropriately.</li><li>SSL encryption</li><li>...</li></ul><p>Just to name few. For now, these settings are left aside and the focus is to establish a minimal streaming replication setup.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="authenticating-secondaries-on-the-primary"></a>Authenticating Secondaries on the Primary<a class="hash-link" href="#authenticating-secondaries-on-the-primary" title="Direct link to heading">#</a></h3><p>In order to allow secondaries to connect to the primary, a replication user (role) has to be created on the primary, e.g. with the username <code>replicator</code>. </p><p>This <code>replicator</code> user will be granted the <code>REPLICATION</code> and <code>LOGIN</code>privilege. In contrast to the <code>SUPERUSER</code> privilege, the <code>REPLICATION</code> privilege doesn&#x27;t allow altering any data. For the purpose of replication this isn&#x27;t necessary.</p><p>Creating the replication user on the primary server can be achieved by using <code>psql</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">CREATE </span><span class="token environment constant" style="color:rgb(130, 170, 255)">USER</span><span class="token plain"> replicator WITH REPLICATION ENCRYPTED PASSWORD </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;secret&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In PostgreSQL authentication is controlled by the configuration file <code>pg_hba.conf</code> so that a record for the <code>replicator</code> user is necessary.</p><p>The necessary <code>pg_hba.conf</code> entries have the following format:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token function" style="color:rgb(130, 170, 255)">host</span><span class="token plain">    replication  replicator  host1  md5</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">host</span><span class="token plain">    replication  replicator  host2  md5</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">host</span><span class="token plain">    replication  replicator  host3  md5</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Note, that actually we only need two hosts for two secondaries. However, we may want to enable leader election at some point. So it makes sense to have a single <code>pg_hba.conf</code> that will work if applied to any of the servers when elected to become the new primary.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="configure-access-of-secondaries-to-the-primary"></a>Configure Access of Secondaries to the Primary<a class="hash-link" href="#configure-access-of-secondaries-to-the-primary" title="Direct link to heading">#</a></h4><p>Now that the primary is configured to accept incoming replication requests from secondaries, secondaries have to be configured to do exactly this.</p><p>As mentioned before, the <code>primary_conninfo</code> has to be configured in the <code>postgresql.conf</code> config file. It is not neccessary to make this adjustment manually.</p><p>A secondary node may join a PostgreSQL replication cluster at a later time. In this case the primary as well as older secondaries already have data but the new secondary hasn&#x27;t. In order to bring such a new secondary up to speed, PostgreSQL offers the <code>pg_basebackup</code> command [2]. Executing <code>pg_basebackup</code> will achieve two important goals.</p><p>It will:</p><ol><li>Create a <code>postgresql.auto.conf</code> in the <code>$PGDATA</code> directory with a proper <code>primar_conninfo</code> setting.</li><li>Retrieve a binary copy of all data files of the entire primary server. While doing so it will activate the backup mode when necessary.</li></ol><p>Hence, after running <code>pg_basebackup</code> the new secondary will be properly configured to connect to the primary in both regards: knowing which primary to connect to as well as having the dataset ready to begin streaming replication of subsequent changes.</p><p>Backup data directory of the primary using <code>pg_basebackup</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">-h primary.hostname -U replicator -p </span><span class="token number" style="color:rgb(247, 140, 108)">5432</span><span class="token plain"> -D </span><span class="token variable" style="color:rgb(214, 222, 235)">$PGDATA</span><span class="token plain"> -Fp -Xs -R</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Where <code>primary.hostname</code> has to be replaced with the actual hostname.</p><p>Note that initializing an empty set of three cluster nodes: one primary and two secondaries requires to initalize the primary by executing <code>initdb</code> while on the secondaries <code>pg_basebackup</code> is to be executed.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>In order to set up streaming replication both the primary as well as the secondary servers have to be configured.</p><ul><li><code>postgresql.conf</code> has to be changed to enable write-adead loggin (WAL).</li><li>A replication user with <code>REPLICATION</code> and <code>LOGIN</code> privileges has to be created.</li><li>Changes of <code>pg_hba.conf</code> grant secondaries access to the primary using the replication user.</li><li>Execute <code>initdb</code> on the primary and <code>pg_basebackup</code> on secondaries.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="links"></a>Links<a class="hash-link" href="#links" title="Direct link to heading">#</a></h2><ol><li>PostgreSQL 12 Documentation - Streaming Replication, <a href="https://www.postgresql.org/docs/12/warm-standby.html#STREAMING-REPLICATION" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/12/warm-standby.html#STREAMING-REPLICATION</a></li><li>PostgreSQL 12 Documentation - pg_basebackup, <a href="https://www.postgresql.org/docs/12/app-pgbasebackup.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/12/app-pgbasebackup.html</a></li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/postgresql/postgresql-theory/streaming-replication"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« PostgreSQL Streaming Replication</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/postgresql/stateful-sets-revisited/stateful-sets-revisited"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">StatefulSets Revisited Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#setting-up-streaming-replication" class="table-of-contents__link">Setting up Streaming Replication</a><ul><li><a href="#authenticating-secondaries-on-the-primary" class="table-of-contents__link">Authenticating Secondaries on the Primary</a></li></ul></li><li><a href="#summary" class="table-of-contents__link">Summary</a></li><li><a href="#links" class="table-of-contents__link">Links</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">More from anynines</h4><ul class="footer__items"><li class="footer__item"><a href="https://anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" rel="noopener noreferrer" class="footer__link-item">anynines.com</a></li><li class="footer__item"><a href="https://paas.anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" rel="noopener noreferrer" class="footer__link-item">anynines PaaS</a></li><li class="footer__item"><a href="https://anynines.com/jobs/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" rel="noopener noreferrer" class="footer__link-item">Jobs at anynines</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Follow us</h4><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/anynines" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://www.linkedin.com/company/anynines/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn</a></li><li class="footer__item"><a href="https://instagram.com/anyninescom" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.anynines.com/imprint" target="_blank" rel="noopener noreferrer" class="footer__link-item">Imprint</a></li><li class="footer__item"><a href="https://www.anynines.com/data-privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2021 anynines GmbH.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c175611c.js"></script>
<script src="/assets/js/main.4c268502.js"></script>
</body>
</html>