<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.58">
<title data-react-helmet="true">Streaming Replication ConfigMaps | Kubernetes Training</title><meta data-react-helmet="true" property="og:image" content="https://anynines.github.io/img/logo.svg"><meta data-react-helmet="true" property="twitter:image" content="https://anynines.github.io/img/logo.svg"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for Kubernetes Training"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Streaming Replication ConfigMaps | Kubernetes Training"><meta data-react-helmet="true" name="description" content="As mentioned previously, the postgresql.conf needs refinement to activate the streaming replication. For this purpose we create a local postgresql.conf which will be mounted in to the Pods using ConfigMaps. Also we need to setup the authentication in pg_hba.conf."><meta data-react-helmet="true" property="og:description" content="As mentioned previously, the postgresql.conf needs refinement to activate the streaming replication. For this purpose we create a local postgresql.conf which will be mounted in to the Pods using ConfigMaps. Also we need to setup the authentication in pg_hba.conf."><meta data-react-helmet="true" property="og:url" content="https://anynines.github.io/postgresql/40-building-the-pg-stateful-set/streaming-replication-configmaps"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://anynines.github.io/postgresql/40-building-the-pg-stateful-set/streaming-replication-configmaps"><link rel="stylesheet" href="/styles.3242ed13.css">
<link rel="preload" href="/styles.3e1a9644.js" as="script">
<link rel="preload" href="/runtime~main.1a262263.js" as="script">
<link rel="preload" href="/main.966e7428.js" as="script">
<link rel="preload" href="/1.040ff6b2.js" as="script">
<link rel="preload" href="/2.90b88e03.js" as="script">
<link rel="preload" href="/62.c8c91393.js" as="script">
<link rel="preload" href="/61.9830b7a6.js" as="script">
<link rel="preload" href="/ec1ed54d.cede18ae.js" as="script">
<link rel="preload" href="/17896441.6d66ffd8.js" as="script">
<link rel="preload" href="/900aa0c8.54837567.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/training-overview"><img class="navbar__logo" src="/img/logo.svg" alt="anynines"><strong class="navbar__title">Kubernetes Training</strong></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/training-overview"><img class="navbar__logo" src="/img/logo.svg" alt="anynines"><strong class="navbar__title">Kubernetes Training</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp" role="complementary"><div class="sidebar_1kLs"><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLinkText_2sSe">Introduction</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/training-overview">Kubernetes Training Overview</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2sSe">Containerization</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/containerization/container-overview">Container Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/containerization/container-intro">Containers Basics</a></li><li class="menu__list-item"><a class="menu__link menuLinkText_2sSe" tabindex="0">Docker</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docker/installation">Docker Installation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docker/docker-basics">Docker Basics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docker/creating-images">Creating Container Images</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docker/simple-web-app">Containerizing a Simple Web App</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docker/publish-image">Publishing a Container Image</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docker/container-workflow">The Container Workflow</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docker/docker-cheatsheet">Docker Cheat Sheet</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2sSe">Kubernetes</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/kubernetes-overview">Kubernetes Overview</a></li><li class="menu__list-item"><a class="menu__link menuLinkText_2sSe" tabindex="0">Basics</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/10-basics/kubectl">kubectl Basics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/10-basics/namespaces">Namespaces</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/10-basics/container-shell">Container Shell Access</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2sSe" tabindex="0">Pods</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/20-pods/introduction">Pods</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2sSe" tabindex="0">ReplicaSets and Services</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/40-replicaset-and-service/introduction">ReplicaSets and Services</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/40-replicaset-and-service/replicasets">ReplicaSets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/40-replicaset-and-service/services">Services</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/40-replicaset-and-service/ingress">Ingress</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/40-replicaset-and-service/tidyup">Tyding Up</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2sSe" tabindex="0">Deployments</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/50-deployments/deployments">Deployments</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2sSe" tabindex="0">ConfigMaps and Secrets</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/60-configmaps-and-secrets/configmaps-and-secrets">ConfigMaps and Secrets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/60-configmaps-and-secrets/configmaps">ConfigMaps</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/60-configmaps-and-secrets/exercise-explanation">Exercise Explanation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/60-configmaps-and-secrets/configmaps-volume-mounts">ConfigMap Volume Mounts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/60-configmaps-and-secrets/secrets">Secrets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/60-configmaps-and-secrets/secrets-exercise-explanation">Secrets Exercise Explanation</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2sSe" tabindex="0">Jobs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/70-jobs/jobs">Jobs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/70-jobs/advanced-jobs">Advanced Job Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/70-jobs/parallel-jobs">Parallel Jobs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/70-jobs/cron-jobs">CronJobs</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2sSe" tabindex="0">StatefulSets</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/80-stateful-sets/persistent-volumes">Persistent Volumes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/80-stateful-sets/persistent-volumes-exercise">Persistent Volumes Excercise</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/80-stateful-sets/stateful-sets">StatefulSets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/80-stateful-sets/stateful-set-postgresql">PostgreSQL StatefulSet</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/80-stateful-sets/stateful-set-headless-service">Headless Service</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/80-stateful-sets/stateful-set-vs-replicasets">StatefulSet vs. ReplicaSets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/80-stateful-sets/stateful-set-psql-access-to-postgresql">PSQL Access to PostgreSQL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/80-stateful-sets/stateful-set-application-access">Application Access to a StatefulSet</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kubernetes/80-stateful-sets/stateful-set-conclusions">Conclusions</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2sSe">PostgreSQL on Kubernetes</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-overview">Overview</a></li><li class="menu__list-item"><a class="menu__link menuLinkText_2sSe" tabindex="0">PostgreSQL Replication</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/20-postgresql-theory/why-use-replication">Why use Replication?</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/20-postgresql-theory/replication-outline">Replication Outline</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/20-postgresql-theory/streaming-replication">PostgreSQL Streaming Replication</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/20-postgresql-theory/setting-up-streaming-replication">Setting up Streaming Replication</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2sSe" tabindex="0">StatefulSet with Replication</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/30-stateful-sets-revisited/stateful-sets-revisited">StatefulSets Revisited</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/40-building-the-pg-stateful-set/pg-service-primary">Service to Connnect to the Primary</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/postgresql/40-building-the-pg-stateful-set/streaming-replication-configmaps">Streaming Replication ConfigMaps</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/40-building-the-pg-stateful-set/streaming-replication-sfs-init">Initializing the StatefulSet</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/40-building-the-pg-stateful-set/replication-user">Creating a Replication User</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/40-building-the-pg-stateful-set/verify-replication">Verifying the Replication</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-outro">Outro</a></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="container padding-vert--lg docItemWrapper_1cc7"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">Streaming Replication ConfigMaps</h1></header><div class="markdown"><p>As mentioned previously, the <code>postgresql.conf</code> needs refinement to activate the streaming replication. For this purpose we create a local <code>postgresql.conf</code> which will be mounted in to the Pods using ConfigMaps. Also we need to setup the authentication in <code>pg_hba.conf</code>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="configmaps-and-volume-mounts"></a>ConfigMaps and Volume Mounts<a aria-hidden="true" tabindex="-1" class="hash-link" href="#configmaps-and-volume-mounts" title="Direct link to heading">#</a></h2><p>Beside of getting the configuration files <code>postgresql.conf</code> and <code>pg_hba.conf</code> right, it is also necessary to inject these configuration files into the StatefulSet while having the option to update these config files throughout the lifecycle of the StatefulSet. As there can be use cases requiring the modification of config files but do not require a modification of the underlying container, configs should be maintained separately from the container images. Even a dedicated container image would be too inflexible. So as the name implies, the Kubernets ConfigMap is a suitable tool to handle this demand well.</p><p>Each ConfigMap may contain a mulitple key value pairs. As seen in previous lessons, it is possible to create such ConfigMaps from files where the filename becomes the key and their contents are turned into the corresponding values.</p><p>Once such a ConfigMap is created, it can be mounted into containers as a Volume. This will expose keys as files. To the container these config files will appear as ordinary files. In the StatefulSet definition we will then mount the ConfigMap into the <code>/etc/postgresql</code> directory.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="postgresqlconf"></a><code>postgresql.conf</code><a aria-hidden="true" tabindex="-1" class="hash-link" href="#postgresqlconf" title="Direct link to heading">#</a></h2><p>We assume the PostgreSQL cluster to have one (1) primary and two (2) secondaries with a total number of three (3) Pods in the StatefulSet. For production usage, the number of replicas must be configurable in a <code>m = 2n+1</code> fashion with <code>n&gt;=1</code> which means <code>1, 3, 5, ...</code> Pods in the StatefulSet. </p><p>This requires setting values in config files dynamically which is not only required to set up the streaming replication but also to dynamically adapt PostgreSQL settings to container memory and CPU limits as well as the size of the Persistent Volumes. However, this needs to be covered in a later stage. For now, we are focused on getting the streaming replication going.</p><p>As it should later be possible to turn any secondary into a primary, the config files for all nodes in the cluster will structurally be the same.</p><p>Create the ConfigMap:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">kubectl create configmap postgresql-configs --from-file</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">postgresql.conf</span></div></div></div></div></div><p>The ConfigMap <code>postgresql-configs</code> will then be mounted into the StatefulSet as a Volume mount. This will create a directory containing the <code>postgresql.conf</code> file.</p><p>By default PostgreSQL will search for the <code>postgresql.conf</code> file in the <code>$PGDATA</code> directory. This is not desired as <code>$PGDATA</code> is already a Volume mount. Therefore, it is necessary to point PostgreSQL to the exact filepath of the designated <code>postgresql.conf</code> file. The exclusive way to achieve this is by starting PostgreSQL with the following command line option:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">postgresql -c </span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">config_file</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">/etc/postgresql/postgresql.conf</span></div></div></div></div></div><p>The final <code>postgresql.conf</code> including some adjustements that have yet to be discussed looks like this:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-conf codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain"># -----------------------------</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># PostgreSQL configuration file</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># -----------------------------</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># a8s-pg</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">hba_file = &#x27;/etc/postgresql/pg_hba.conf&#x27;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># a8s-pg</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">#------------------------------------------------------------------------------</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># CONNECTIONS AND AUTHENTICATION</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">#------------------------------------------------------------------------------</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># - Connection Settings -</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">listen_addresses = &#x27;*&#x27;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">#------------------------------------------------------------------------------</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># WRITE-AHEAD LOG</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">#------------------------------------------------------------------------------</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># - Settings -</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># a8s-pg</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">wal_level = replica         # minimal, replica, or logical</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># a8s-pg</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># a8s-pg</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># Required for pg_rewind capability when standby goes out of sync with master</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">wal_log_hints = on          # also do full page writes of non-critical updates</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># a8s-pg</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">#------------------------------------------------------------------------------</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># REPLICATION</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">#------------------------------------------------------------------------------</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># - Sending Servers -</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># Set these on the master and on any standby that will send replication data.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># a8s-pg</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># Sets the maximum number of concurrent connections from the standby servers.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">max_wal_senders = 3     # max number of walsender processes</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># a8s-pg</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># a8s-pg</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># Segments of WAL logs so that they are not deleted before standby consumes them.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">wal_keep_segments = 8   # in logfile segments; 0 disables</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># a8s-pg</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># a8s-pg</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># Standby role. This is ignored when the server is running as master.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">hot_standby = on            # &quot;off&quot; disallows queries during recovery</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># a8s-pg</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="pg_hbaconf"></a><code>pg_hba.conf</code><a aria-hidden="true" tabindex="-1" class="hash-link" href="#pg_hbaconf" title="Direct link to heading">#</a></h2><p>In order to allow secondaries to connect to the master to retrieve replicas, the master must allow secondaries to authenticate. This is done in the <code>pg_hba.conf</code> file. </p><p>As all secondaries should be able to become primaries, it makes sense to configure all nodes right from the beginning.</p><p>Similar to <code>postgres.conf</code> the <code>pg_hba.conf</code> file is assumed to be located in the <code>$PGDATA</code> dir. While it is possible to supply the <code>postgres</code> startup command with a <code>pg_hba.conf</code> location there is a more elegant way: set the location in the <code>postgres.conf</code> file.</p><p>Create a <code>pg_hba.conf</code> and <strong>recreate the <code>postgresql-configs</code> Config Map</strong>:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">kubectl create configmap postgresql-configs --from-file</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">postgresql.conf --from-file</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">pg_hba.conf</span></div></div></div></div></div><p>The location of the <code>pg_hba.conf</code> file will be: <code>/etc/postgresql/pg_hba.conf</code>.</p><p>As you can see in <code>postgresql.conf</code> the following line already exists and ensures to read our <code>pg_hba.conf</code> from the Volume mount:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">hba_file </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;/etc/postgresql/pg_hba.conf&#x27;</span></div></div></div></div></div><p>The syntax of <code>pg_hba.conf</code> has been explained earlier.</p><p>One entry per cluster Pod is required.</p><p>Just to remember: the syntax is as follows:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># host  DATABASE     USER        ADDRESS           METHOD  [OPTIONS]</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">host</span><span class="token plain">    replication  replicator  </span><span class="token number" style="color:rgb(247, 140, 108)">192.168</span><span class="token plain">.0.107/32  md5</span></div></div></div></div></div><p>Hence, we need three entries. This will allow a client to connect to itself but a single config can be used across all cluster nodes.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token function" style="color:rgb(130, 170, 255)">host</span><span class="token plain">    replication  replicator  postgresql-sfs-0.postgresql-svc.pg.svc.cluster.local  md5</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">host</span><span class="token plain">    replication  replicator  postgresql-sfs-1.postgresql-svc.pg.svc.cluster.local  md5</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">host</span><span class="token plain">    replication  replicator  postgresql-sfs-2.postgresql-svc.pg.svc.cluster.local  md5</span></div></div></div></div></div><p>Using the DNS names created by the corresponding Kubernetes Service ensures a stable network identity as the underlying Pod IP addresses may change when Pods need to be rescheduled (e.g. during node maintenance).</p><p>However, this does not work as there is a deadlock between starting the Pod and updating the DNS entries of the <code>postgresql-svc</code> service. Within the Pods Postgres will only start if the DNS entries resolve but these DNS entries depend on the Pods being ready so that the corresponding Service Endpoints will be created. </p><p>There are solutions to this problem but for now we&#x27;ll circumnavigate the issue with by being less restrictive:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># host  DATABASE     USER        ADDRESS  METHOD  [OPTIONS]</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">host</span><span class="token plain">    replication  replicator  samenet  md5</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">host</span><span class="token plain">    replication  replicator  samenet  md5</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">host</span><span class="token plain">    replication  replicator  samenet  md5</span></div></div></div></div></div><p>This won&#x27;t restrict access to a particular IP address or DNS name - desirable for productive use - but limit access to IP addresses in the same subnet - the internal Kubernetes network.</p><p>Another entry needs to be added to allow the <code>postgres</code> user to login in remotely. This will be needed when executing administrative Kubernetes Jobs such as creating the <code>replication</code> user.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token function" style="color:rgb(130, 170, 255)">host</span><span class="token plain">    all          postgres    samenet  md5</span></div></div></div></div></div><p>The final <code>pg_hba.conf</code> then looks similar to this:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-conf codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain"># TYPE  DATABASE        USER            ADDRESS                 METHOD</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># &quot;local&quot; is for Unix domain socket connections only</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">local   all             all                                     trust</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># IPv4 local connections:</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">host    all             all             127.0.0.1/32            trust</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># Allow replication connections from localhost, by a user with the</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># replication privilege.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">local   replication     all                                     trust</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">host    replication     all             127.0.0.1/32            trust</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">host    replication     all             ::1/128                 trust</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">host    replication  replicator  samenet  md5</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">host    replication  replicator  samenet  md5</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">host    replication  replicator  samenet  md5</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"># Allow psql connections from Kubernetes Jobs</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">host    all          postgres    samenet  md5</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="summary"></a>Summary<a aria-hidden="true" tabindex="-1" class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>The required PostgreSQL configuration files <code>postgresql.conf</code> and <code>pg_hba.conf</code> are ready.</p><p><code>postgresql.conf</code> activates write-ahead logging and sets the path to our custom version of <code>pg_hba.conf</code> while the latter creates the necessary prerequisites for authenticating the <code>replication</code> and <code>postgres</code> users.</p><p>Both files are stored in the <code>postgresql-configs</code> ConfigMap. This way the config files can be updated independently from the PostgreSQL container image.</p><p>In the following we will define the StatefulSet specification and look into how the replication user is created.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="links"></a>Links<a aria-hidden="true" tabindex="-1" class="hash-link" href="#links" title="Direct link to heading">#</a></h2><ol><li>PostgreSQL 12 Documentation - pg_basebackup, <a href="https://www.postgresql.org/docs/12/app-pgbasebackup.html">https://www.postgresql.org/docs/12/app-pgbasebackup.html</a></li></ol></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/postgresql/40-building-the-pg-stateful-set/pg-service-primary"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Service to Connnect to the Primary</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/postgresql/40-building-the-pg-stateful-set/streaming-replication-sfs-init"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Initializing the StatefulSet »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#configmaps-and-volume-mounts" class="table-of-contents__link">ConfigMaps and Volume Mounts</a></li><li><a href="#postgresqlconf" class="table-of-contents__link"><code>postgresql.conf</code></a></li><li><a href="#pg_hbaconf" class="table-of-contents__link"><code>pg_hba.conf</code></a></li><li><a href="#summary" class="table-of-contents__link">Summary</a></li><li><a href="#links" class="table-of-contents__link">Links</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">More from anynines</h4><ul class="footer__items"><li class="footer__item"><a href="https://anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web">anynines.com</a></li><li class="footer__item"><a href="https://paas.anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://paas.anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web">anynines PaaS</a></li><li class="footer__item"><a href="https://anynines.com/jobs/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://anynines.com/jobs/?utm_source=k8s-tutorial&amp;utm_medium=web">Jobs at anynines</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Follow us</h4><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/anynines" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://twitter.com/anynines">Twitter</a></li><li class="footer__item"><a href="https://www.linkedin.com/company/anynines/" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://www.linkedin.com/company/anynines/">LinkedIn</a></li><li class="footer__item"><a href="https://instagram.com/anyninescom" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://instagram.com/anyninescom">Instagram</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.anynines.com/imprint" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://www.anynines.com/imprint">Imprint</a></li><li class="footer__item"><a href="https://www.anynines.com/data-privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://www.anynines.com/data-privacy">Privacy Policy</a></li></ul></div></div><div class="text--center"><div>Copyright © 2021 anynines GmbH.</div></div></div></footer></div>
<script src="/styles.3e1a9644.js"></script>
<script src="/runtime~main.1a262263.js"></script>
<script src="/main.966e7428.js"></script>
<script src="/1.040ff6b2.js"></script>
<script src="/2.90b88e03.js"></script>
<script src="/62.c8c91393.js"></script>
<script src="/61.9830b7a6.js"></script>
<script src="/ec1ed54d.cede18ae.js"></script>
<script src="/17896441.6d66ffd8.js"></script>
<script src="/900aa0c8.54837567.js"></script>
</body>
</html>