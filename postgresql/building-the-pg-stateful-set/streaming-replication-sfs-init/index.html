<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<title data-react-helmet="true">Initializing the StatefulSet | Kubernetes Training</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://learn.kubernetes.anynines.com/img/logo.svg"><meta data-react-helmet="true" name="twitter:image" content="https://learn.kubernetes.anynines.com/img/logo.svg"><meta data-react-helmet="true" property="og:url" content="https://learn.kubernetes.anynines.com/postgresql/building-the-pg-stateful-set/streaming-replication-sfs-init"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Initializing the StatefulSet | Kubernetes Training"><meta data-react-helmet="true" name="description" content="Before the replication user can be created, the StatefulSet has to be created. Only after the PostgreSQL server is running the replication user can be created. Therefore, the next step is to engineer the StatefulSet specification."><meta data-react-helmet="true" property="og:description" content="Before the replication user can be created, the StatefulSet has to be created. Only after the PostgreSQL server is running the replication user can be created. Therefore, the next step is to engineer the StatefulSet specification."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://learn.kubernetes.anynines.com/postgresql/building-the-pg-stateful-set/streaming-replication-sfs-init"><link data-react-helmet="true" rel="alternate" href="https://learn.kubernetes.anynines.com/postgresql/building-the-pg-stateful-set/streaming-replication-sfs-init" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://learn.kubernetes.anynines.com/postgresql/building-the-pg-stateful-set/streaming-replication-sfs-init" hreflang="x-default"><script data-react-helmet="true" id="oil-configuration" type="application/configuration">
          {
            "config_version": 1,
            "publicPath": "/",
            "advanced_settings": true,
            "default_to_optin": true,
            "gdpr_applies_globally": true,
            "timeout": -1,
            "local_url": "/oils-de.json",
            "iabVendorListUrl": "/vendorlist.json",
            "customVendorListUrl": "/vendors.json",
          }
        </script><script data-react-helmet="true" src="/oilstub.1.3.5-SNAPSHOT.min.js"></script><script data-react-helmet="true" src="/oil.1.3.5-SNAPSHOT.min.js"></script><link rel="stylesheet" href="/assets/css/styles.f7ace848.css">
<link rel="preload" href="/assets/js/runtime~main.dc5c9b92.js" as="script">
<link rel="preload" href="/assets/js/main.de5502fe.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/training-overview"><img src="/img/logoLight.svg" alt="anynines" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="anynines" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Kubernetes Training</b></a><a class="navbar__item navbar__link" href="/containerization/container-overview">Container Training</a><a class="navbar__item navbar__link" href="/kubernetes/kubernetes-overview">Kubernetes Training</a><a class="navbar__item navbar__link" href="/postgresql/postgresql-overview">PostgreSQL on Kubernetes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/anynines/a9s-kubernetes-training" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Fork me<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/anynines" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://paas.anynines.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>anynines PaaS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Introduction</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Containerization</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Kubernetes</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">PostgreSQL on Kubernetes</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-overview">Overview</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">PostgreSQL Replication</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">StatefulSet with Replication</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/stateful-sets-revisited/stateful-sets-revisited">StatefulSets Revisited</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/building-the-pg-stateful-set/pg-service-primary">Service to Connect to the Primary</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/building-the-pg-stateful-set/streaming-replication-configmaps">Streaming Replication ConfigMaps</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/postgresql/building-the-pg-stateful-set/streaming-replication-sfs-init">Initializing the StatefulSet</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/building-the-pg-stateful-set/replication-user">Creating a Replication User</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/building-the-pg-stateful-set/verify-replication">Verifying the Replication</a></li></ul></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-outro">Outro</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Initializing the StatefulSet</h1></header><p>Before the replication user can be created, the StatefulSet has to be created. Only after the PostgreSQL server is running the replication user can be created. Therefore, the next step is to engineer the StatefulSet specification.</p><p>As discussed before, bootstrapping an empty PostgreSQL StatefulSet with <code>3</code> replicas requires executing <code>initdb</code> on the primary and <code>pg_basebackup</code> on the secondary.</p><p>Once the Primary is up and running, the Secondaries have to be brought in sync with it which can be accomplished executing <code>pg_basebackup</code> [1] on all Secondaries. This will create the <code>$PGDATA</code> directories and retrieve the data set from the Primary. </p><p>Once these directories have been created, the StatefulSet shall not execute the <code>pg_basebackup</code> command on subsequent restarts. As part of the StatefulSet&#x27;s lifecycle it will surely happen that the Pods will be re-created. This may happen during Kubernetes Node failures or StatefulSet updates, for example. The Pods will then start with a Persistent Volume that does not need initialization. Therefore, the initialization logic requires nested conditionals and must recognize the Pod&#x27;s role in the cluster by knowing whether the Pod is the primary or not and whether the data directory has already been created.</p><p>While theoretically a complex container command with appropriate args could be pasted into the StatefulSet YAML description, this would be hard to debug. On the other hand, modifying the PostgreSQL base image or creating a separate container image to execute a single script seems to be unnecessary overhead. If more scripts accumulate over time, collecting them in a CI/CD backed container image makes sense. For now, a script stored into another ConfigMap will help us to get going and integrate quickly during development.</p><p>The first hurdle to overcome is to make the Pod introspect itself. In particular the Pod&#x27;s role must be determined. For now the cluster topology is static, the first Pod is declared as the Primary. Hence, if the label information was available in the Pod, this helps determine its role.</p><p>The Kubernetes Downward API [1] can be used to mount metadata such as Pod labels and Pod resources as a Volume into containers of the Pod:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><pre tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> podinfo</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">downwardAPI</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">items</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;labels&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">fieldRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token key atrule">fieldPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> metadata.labels</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;annotations&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">fieldRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token key atrule">fieldPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> metadata.annotations</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Equipped with access to the Pod labels, the following BASH script accomplishes the initialization as described above. </p><p>Create the file <code>pg-init.sh</code> with the following content:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">PGDATA</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">/var/lib/postgresql/data/pgdata</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">PODINFO_LABELS_FILE</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">/etc/podinfo/labels</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">!</span><span class="token plain"> -d </span><span class="token variable" style="color:rgb(214, 222, 235)">$PGDATA</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">then</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;The postgresql data directory </span><span class="token string variable" style="color:rgb(214, 222, 235)">$PGDATA</span><span class="token string" style="color:rgb(173, 219, 103)"> does not exist.&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">!</span><span class="token plain"> -e </span><span class="token variable" style="color:rgb(214, 222, 235)">$PODINFO_LABELS_FILE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">then</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;  The podinfo file </span><span class="token string variable" style="color:rgb(214, 222, 235)">$PODINFO_LABELS_FILE</span><span class="token string" style="color:rgb(173, 219, 103)"> does not exist. Did you create a downward API volume? For more details see: https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;  Exitting with a failure.&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">exit</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">fi</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># /etc/podinfo/labels only exists if the Kubernetes Downward API is mounted as volume.</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># For more details see: https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">cat</span><span class="token plain"> </span><span class="token variable" style="color:rgb(214, 222, 235)">$PODINFO_LABELS_FILE</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> -q </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;statefulset.kubernetes.io/pod-name=&quot;postgresql-sfs-0&quot;&#x27;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(214, 222, 235)">$PODINFO_LABELS_FILE</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">then</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;  Identified this Pod to be the static primary: postgresql-sfs-0.&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;  Executing initdb...&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    initdb --username postgres --pwfile </span><span class="token operator" style="color:rgb(127, 219, 202)">&lt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(214, 222, 235)">$POSTGRES_PASSWORD</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token variable" style="color:rgb(214, 222, 235)">$?</span><span class="token plain"> -ne </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">then</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;  Failed to execute initdb.&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">exit</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">fi</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">else</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;  Identified this Pod to a secondary.&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;  Executing pg_basebackup...&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /usr/lib/postgresql/14/bin/pg_basebackup -h postgresql-primary.k8s-training.svc.cluster.local -U replicator -p </span><span class="token number" style="color:rgb(247, 140, 108)">5432</span><span class="token plain"> -D </span><span class="token variable" style="color:rgb(214, 222, 235)">$PGDATA</span><span class="token plain"> -Fp -Xs -R</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token variable" style="color:rgb(214, 222, 235)">$?</span><span class="token plain"> -ne </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">then</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;  Failed to execute pg_basebackup.&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">exit</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">fi</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">fi</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;  Done.&quot;</span><span class="token plain">  </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">else</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Found the postgresql data directory at </span><span class="token string variable" style="color:rgb(214, 222, 235)">$PGDATA</span><span class="token string" style="color:rgb(173, 219, 103)">.&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">fi</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Starting PostgreSQL...&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/usr/lib/postgresql/14/bin/postgres -c </span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">config_file</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">/etc/postgresql/postgresql.conf -D </span><span class="token variable" style="color:rgb(214, 222, 235)">$PGDATA</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The script does not use <code>su</code> or <code>sudo</code> but will later be invoked with <code>gosu</code> - a similar tool - to ensure the script is run as the <code>postgres</code> use which ensures the correct ownership of the <code>$PGDATA</code> directory.</p><p>Load the script into a ConfigMap <code>postgresl-utils</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl create configmap postgresql-utils --from-file</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">pg-init.sh</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="the-statefulset"></a>The StatefulSet<a class="hash-link" href="#the-statefulset" title="Direct link to heading">#</a></h2><p>The StatefulSet description of PostgreSQL looks similar to following. Store it in a file named <code>30-stateful-set.yaml</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> apps/v1</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> StatefulSet</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">sfs</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">a </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># has to match .spec.template.metadata.labels</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">serviceName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;postgresql-svc&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># by standard is 1</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">a </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># has to match .spec.selector.matchLabels</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">db</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgres</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token number" style="color:rgb(247, 140, 108)">14.5</span><span class="token plain">        </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;gosu&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;postgres&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;bash&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/utils/pg-init.sh&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_PASSWORD</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">secrets</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_PASSWORD              </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_REPLICATION_USERNAME</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">replication</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">user</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_REPLICATION_USERNAME</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_REPLICATION_PASSWORD</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">replication</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">user</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_REPLICATION_PASSWORD</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> PGPASSWORD </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># for pg_basebackup. It will authenticate as the replication user &quot;replicator&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">replication</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">user</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_REPLICATION_PASSWORD</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> PGDATA</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /var/lib/postgresql/data/pgdata</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">containerPort</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">5432</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">port</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> data</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">mountPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /var/lib/postgresql/data</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> configs</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">mountPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/postgresql        </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> podinfo</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">mountPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /etc/podinfo</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> utils</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">mountPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /utils</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> configs</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">configMap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">configs</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> utils</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">configMap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">utils          </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> podinfo</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">downwardAPI</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">items</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;labels&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">fieldRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token key atrule">fieldPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> metadata.labels</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;annotations&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">fieldRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token key atrule">fieldPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> metadata.annotations</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> data</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">accessModes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;ReadWriteOnce&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">requests</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 1Gi</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In conjunction with the previously created Services, ConfigMaps and Secrets you can instantiate the StatefulSet by applying its YAML spec:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl apply -f </span><span class="token number" style="color:rgb(247, 140, 108)">30</span><span class="token plain">-stateful-set.yaml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This will create a StatefulSet along with its <code>3</code> Pods as well as the corresponding Persistent Volume Claims. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">NAME                               READY   STATUS             RESTARTS   AGE</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">postgresql-sfs-0                   </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">/1     Running            </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">          5m20s</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">postgresql-sfs-1                   </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">/1     CrashLoopBackOff   </span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token plain">          5m17s</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">postgresql-sfs-2                   </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">/1     CrashLoopBackOff   </span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token plain">          5m14s</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>While the Primary Pod has been started successfully, the two Secondary Pods are failing.</p><p>A brief look into their logs:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl logs postgresql-sfs-1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Reveals the following failure message:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">statefulset.kubernetes.io/pod-name</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;postgresql-sfs-1&quot;</span><span class="token plain">  Identified this Pod to a secondary.</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  Executing pg_basebackup</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">pg_basebackup: error: could not connect to server: could not translate </span><span class="token function" style="color:rgb(130, 170, 255)">host</span><span class="token plain"> name </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;postgresql-primary.k8s-training.svc.cluster.local&quot;</span><span class="token plain"> to address: Name or </span><span class="token function" style="color:rgb(130, 170, 255)">service</span><span class="token plain"> not known</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  Failed to execute pg_basebackup.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The reason for this is simple: <strong>there is no replication user, yet</strong>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="working-with-statefulsets"></a>Working with StatefulSets<a class="hash-link" href="#working-with-statefulsets" title="Direct link to heading">#</a></h2><p><strong>Be reminded that deleting the StatefulSet will delete the corresponding Pods, but it will not delete the Persistent Volume Claims nor the associated Persistent Volumes</strong>. The lifecycle of Persistent Volume Claims are independent of the StatefulSet. This is to prevent data loss when deleting the StatefulSet, accidentally. For this reason, you will have to delete the Persistent Volume Claims manually when testing the initialization logic for bootstrapping the StatefulSet. Otherwise, the initialization script might behave unexpected as it will see existing artifacts on the Persistent Volumes which will be reattached when a StatefulSet with the same name is created where a prior StatefulSet created Persistent Volume Claims</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>In this section we started connecting the dots. The PostgreSQL streaming replication implementation has been started. An initialization script has been developed enabling the StatefulSet Pods to introspect and determine their static cluster roles <code>Primary</code> or <code>Secondary</code>. Accordingly, the Pods either initialize by executing <code>initdb</code> or <code>pg_basebackup</code>. The corresponding StatefulSet definition has been created and tested.</p><p>In the next step the replication user has to be created so that Secondaries can connect to the Primary to start the streaming replication.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="links"></a>Links<a class="hash-link" href="#links" title="Direct link to heading">#</a></h2><ol><li>Kubernetes Documentation, Tasks, Expose Pod Information to containers Through Files, <a href="https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/</a></li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/postgresql/building-the-pg-stateful-set/streaming-replication-configmaps"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Streaming Replication ConfigMaps</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/postgresql/building-the-pg-stateful-set/replication-user"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Creating a Replication User Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-statefulset" class="table-of-contents__link">The StatefulSet</a></li><li><a href="#working-with-statefulsets" class="table-of-contents__link">Working with StatefulSets</a></li><li><a href="#summary" class="table-of-contents__link">Summary</a></li><li><a href="#links" class="table-of-contents__link">Links</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">More from anynines</h4><ul class="footer__items"><li class="footer__item"><a href="https://anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" rel="noopener noreferrer" class="footer__link-item">anynines.com</a></li><li class="footer__item"><a href="https://paas.anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" rel="noopener noreferrer" class="footer__link-item">anynines PaaS</a></li><li class="footer__item"><a href="https://anynines.com/jobs/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" rel="noopener noreferrer" class="footer__link-item">Jobs at anynines</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Follow us</h4><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/anynines" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://www.linkedin.com/company/anynines/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn</a></li><li class="footer__item"><a href="https://instagram.com/anyninescom" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.anynines.com/imprint" target="_blank" rel="noopener noreferrer" class="footer__link-item">Imprint</a></li><li class="footer__item"><a href="https://www.anynines.com/data-privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2023 anynines GmbH.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.dc5c9b92.js"></script>
<script src="/assets/js/main.de5502fe.js"></script>
</body>
</html>