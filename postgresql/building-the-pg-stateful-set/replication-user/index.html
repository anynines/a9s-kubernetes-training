<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<title data-react-helmet="true">Creating a Replication User | Kubernetes Training</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://learn.kubernetes.anynines.com/img/logo.svg"><meta data-react-helmet="true" name="twitter:image" content="https://learn.kubernetes.anynines.com/img/logo.svg"><meta data-react-helmet="true" property="og:url" content="https://learn.kubernetes.anynines.com/postgresql/building-the-pg-stateful-set/replication-user"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Creating a Replication User | Kubernetes Training"><meta data-react-helmet="true" name="description" content="Previously we have created a StatefulSet that now requires a replication user on the Primary to allow Secondaries to connect. In order to achieve this the following steps are taken:"><meta data-react-helmet="true" property="og:description" content="Previously we have created a StatefulSet that now requires a replication user on the Primary to allow Secondaries to connect. In order to achieve this the following steps are taken:"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://learn.kubernetes.anynines.com/postgresql/building-the-pg-stateful-set/replication-user"><link data-react-helmet="true" rel="alternate" href="https://learn.kubernetes.anynines.com/postgresql/building-the-pg-stateful-set/replication-user" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://learn.kubernetes.anynines.com/postgresql/building-the-pg-stateful-set/replication-user" hreflang="x-default"><script data-react-helmet="true" id="oil-configuration" type="application/configuration">
          {
            "config_version": 1,
            "publicPath": "/",
            "advanced_settings": true,
            "default_to_optin": true,
            "gdpr_applies_globally": true,
            "timeout": -1,
            "local_url": "/oils-de.json",
            "iabVendorListUrl": "/vendorlist.json",
            "customVendorListUrl": "/vendors.json",
          }
        </script><script data-react-helmet="true" src="/oilstub.1.3.5-SNAPSHOT.min.js"></script><script data-react-helmet="true" src="/oil.1.3.5-SNAPSHOT.min.js"></script><link rel="stylesheet" href="/assets/css/styles.f7ace848.css">
<link rel="preload" href="/assets/js/runtime~main.3b2d4115.js" as="script">
<link rel="preload" href="/assets/js/main.f17ba9dc.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/training-overview"><img src="/img/logoLight.svg" alt="anynines" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="anynines" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Kubernetes Training</b></a><a class="navbar__item navbar__link" href="/containerization/container-overview">Container Training</a><a class="navbar__item navbar__link" href="/kubernetes/kubernetes-overview">Kubernetes Training</a><a class="navbar__item navbar__link" href="/postgresql/postgresql-overview">PostgreSQL on Kubernetes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/anynines/a9s-kubernetes-training" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Fork me<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/anynines" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://paas.anynines.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>anynines PaaS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Introduction</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Containerization</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Kubernetes</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">PostgreSQL on Kubernetes</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-overview">Overview</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">PostgreSQL Replication</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">StatefulSet with Replication</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/stateful-sets-revisited/stateful-sets-revisited">StatefulSets Revisited</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/building-the-pg-stateful-set/pg-service-primary">Service to Connnect to the Primary</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/building-the-pg-stateful-set/streaming-replication-configmaps">Streaming Replication ConfigMaps</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/building-the-pg-stateful-set/streaming-replication-sfs-init">Initializing the StatefulSet</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/postgresql/building-the-pg-stateful-set/replication-user">Creating a Replication User</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/building-the-pg-stateful-set/verify-replication">Verifying the Replication</a></li></ul></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/postgresql/postgresql-outro">Outro</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Creating a Replication User</h1></header><p>Previously we have created a StatefulSet that now requires a replication user on the Primary to allow Secondaries to connect. In order to achieve this the following steps are taken:</p><ol><li>Determine the SQL commands to create the replication user</li><li>Write and test an idempotent script to create the user</li><li>Containerize and test the script</li></ol><p>This follows the principle <em>Operational Model First, Automation Second</em> [1]. Before the automation is written, it must be clear what to achieve and how a sysop would do it. This it the operational model. What needs to be done and which exceptions are to be expected. This it the input for automating the procedure with a script.</p><p>The script should be idempotent so that it can be executed several times causing the desired effect only once. Running the script repeatedly may happen when:</p><ul><li>Running a script during Pod startup.</li><li>Retrying to execute a script that failed to run earlier.</li></ul><p>In order to make the script idempotent it must be checked if the replication user already exists:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">COUNT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">rolname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">FROM</span><span class="token plain"> pg_catalog</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pg_roles </span><span class="token keyword" style="color:rgb(127, 219, 202)">WHERE</span><span class="token plain"> rolname </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;replicator&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The goal is to create a replication user by executing the following SQL command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">USER</span><span class="token plain"> replicator </span><span class="token keyword" style="color:rgb(127, 219, 202)">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">REPLICATION</span><span class="token plain"> ENCRYPTED PASSWORD </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;aREPL1C4Ti0NxLI6Eeth&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>aREPL1C4Ti0NxLI6Eeth</code> should be replaced with a value from the corresponding Kubernetes Secret:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl create secret generic postgresql-replication-user --from-literal</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">POSTGRES_REPLICATION_PASSWORD</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">aREPL1C4Ti0NxLI6Eeth --from-literal</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">POSTGRES_REPLICATION_USERNAME</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">replicator</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Obviously - as with all passwords in this tutorial - a different password should be chosen.</p><p>The replication user <code>replicator</code> will be created in a seaparate container. Note, that the usage of initContainers here is tricky as the initContainer is executed before PostgreSQL has been started. This doesn&#x27;t work as creating a user obviously require the database to be running. Theoretically, PostgreSQL could be started temporarily but this appears to be inelegant. We&#x27;ll come back to this matter later.</p><p>In order to prepare each Pod to become the Primary, the replication user will be created in all Pods of the StatefulSet. Before such a container can be instantiated, an idempotent script for creating the replication user needs to be created.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="the-script"></a>The Script<a class="hash-link" href="#the-script" title="Direct link to heading">#</a></h2><p>The script <code>create-replication-user.rb</code> is written in Ruby [4].</p><p>It reads the environment variables:</p><ul><li><code>POSTGRES_HOSTNAME</code></li><li><code>POSTGRES_DATABASE</code></li><li><code>POSTGRES_USERNAME</code></li><li><code>POSTGRES_PASSWORD</code></li><li><code>POSTGRES_REPLICATION_USERNAME</code></li><li><code>POSTGRES_REPLICATION_PASSWORD</code></li></ul><p>The script can be executed in two &quot;directions&quot;: <code>up</code> and <code>down</code>. Similar to database migrations in Ruby on Rails <code>up</code> will create the replication user while <code>down</code> will remove it. The script is idempotent which means running the script several times in either direction won&#x27;t change the result neither will it raise an error.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><pre tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">#!/usr/bin/ruby</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># https://bundler.io/v2.0/guides/bundler_in_a_single_file_ruby_script.html</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">require &#x27;bundler/inline&#x27;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">gemfile do</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  source &#x27;https://rubygems.org&#x27;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  gem &#x27;pg&#x27;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">end</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># https://deveiate.org/code/pg/</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">require &#x27;pg&#x27;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">require &#x27;pp&#x27;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># One possible abstraction of this class would be a Rails-Migration like pattern </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># to execute SQL statements in both directions create/delete, forward/backward, ...</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">class CreateReplicationUserIfNotExistsAction</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  def initialize</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # Required environment variables</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    @postgres_hostname = ENV[&#x27;POSTGRES_HOSTNAME&#x27;] || &#x27;localhost&#x27;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    @postgres_database = ENV[&#x27;POSTGRES_DATABASE&#x27;] || &#x27;postgres&#x27;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    @postgres_username = ENV[&#x27;POSTGRES_USERNAME&#x27;] || &#x27;postgres&#x27;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    @postgres_password = ENV[&#x27;POSTGRES_PASSWORD&#x27;] || &#x27;tes6Aev8&#x27;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    @postgres_replication_username = ENV[&#x27;POSTGRES_REPLICATION_USERNAME&#x27;] || &#x27;replicator&#x27;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    @postgres_replication_password = ENV[&#x27;POSTGRES_REPLICATION_PASSWORD&#x27;] || &#x27;aREPL1C4Ti0NxLI6Eeth&#x27;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  end</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  protected</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  # True if the replication user exists, false otherwise</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  # Improves readability.</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  def replication_user_exists?(connection)</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      result = connection.exec &quot;SELECT COUNT(rolname) FROM pg_catalog.pg_roles WHERE rolname = &#x27;#{@postgres_replication_username}&#x27;&quot;;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      if result[0][&quot;count&quot;].to_i == 1 then</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        # Does exist</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        return true</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      elsif result[0][&quot;count&quot;].to_i == 0</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        # Does not exist    </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        return false</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      end</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  end</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  # Idempotency. Checks if the user exists and creates it if not.</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  def create_replication_user_if_not_exists(connection)      </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      if replication_user_exists?(connection) then</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        puts &quot;The replication user #{@postgres_replication_username} already exists. Doing nothing.&quot;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      else</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        puts &quot;The replication user #{@postgres_replication_username} doesn&#x27;t exist. Creating it...&quot; </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        create_replication_user(connection)</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        puts &quot;Done creating the replication user.&quot;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      end</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  end</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  def delete_replication_user_if_exists(connection)</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    if replication_user_exists?(connection) </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      puts &quot;The replication user #{@postgres_replication_username} exists and will now be deleted...&quot;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      delete_replication_user(connection)</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      puts &quot;Done deleting the replication user.&quot;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    else</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      puts &quot;The replication user #{@postgres_replication_username} doesn&#x27;t exist. There is nothing to delete. Done.&quot;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    end    </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  end</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  # Creates the user imperatively without checking.</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  def create_replication_user(connection)</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    result = connection.exec &quot;CREATE USER #{@postgres_replication_username} WITH REPLICATION ENCRYPTED PASSWORD &#x27;#{@postgres_replication_password}&#x27;&quot;    </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  end</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  def delete_replication_user(connection)</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    result = connection.exec &quot;DROP ROLE #{@postgres_replication_username}&quot;    </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  end</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  # Create the replication user idempotently.</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  def up    </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    begin</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      connection = PG.connect :host =&gt; @postgres_hostname, :dbname =&gt; @postgres_database, :user =&gt; @postgres_username, :password =&gt; @postgres_password    </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      create_replication_user_if_not_exists(connection)      </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    rescue PG::Error =&gt; e</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        puts &quot;PG::Error occurred: &quot; + e.message     </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        exit(false) # signal a failure by using a non-zero exit code.</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ensure</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        connection.close if connection        </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    end</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  end</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  # Delete the replication user idempotently.</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  def down</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    begin</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      connection = PG.connect :host =&gt; @postgres_hostname, :dbname =&gt; @postgres_database, :user =&gt; @postgres_username, :password =&gt; @postgres_password</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      delete_replication_user_if_exists(connection)</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    rescue PG::Error =&gt; e</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        puts &quot;PG::Error occurred: &quot; + e.message            </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        exit(false) # signal a failure by using a non-zero exit code.</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ensure</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        connection.close if connection </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    end</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  end</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">end</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#TODO Add Unit Tests</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">puts &quot;Executing CreateReplicationUserIfNotExistsAction.&quot;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">direction = ARGV[0] || &quot;up&quot;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">puts &quot;Direction: #{direction}...&quot;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">action = CreateReplicationUserIfNotExistsAction.new</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">if direction.eql?(&quot;up&quot;) then</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  action.up</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">else</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  action.down</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">end</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">puts &quot;Done executing CreateReplicationUserIfNotExistsAction.&quot;</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">exit(true)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now that the script is ready, it must be injected into the Primary Pod. Previously we have used a ConfigMap to inject a script into a container. This has the disadvantage that the script is duplicated for each service instance to keep instance lifecycles independent from another. While this works at a small scale and during development, it can be doubted whether this approach will hold up at a large scale.</p><p>We therefore chose a different route for the <code>create-replication-user.rb</code> script and will containerize it.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="containerizing-the-script"></a>Containerizing the Script<a class="hash-link" href="#containerizing-the-script" title="Direct link to heading">#</a></h3><p>In order to containerize the script, the first step is choosing a base image.
Then a container image must be created and published. Finally, the container image must be executed using a Kubernetes resource to schedule a Pod.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="selecting-the-base-image"></a>Selecting the Base Image<a class="hash-link" href="#selecting-the-base-image" title="Direct link to heading">#</a></h4><p>For executing Ruby the official Docker images can be used [2].
They come in different variants such as the default (<code>&lt;version&gt;</code>), slim (<code>&lt;version&gt;-slim</code>) and alpine (<code>&lt;version&gt;-alpine</code>).</p><p>The default and slim variants are based on Debian. They provide many useful tools and the full power of <code>apt</code>. However, they are very bug.
For this reason the preferred base image variant is <code>alpine</code>. Use it whenever possible with meaningful effort.</p><p>In order to build the <code>pg</code> Gem [3] the regular Debian base image is convenient to use as it ships the necessary dependencies.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Dockerfile"><pre tabindex="0" class="prism-code language-Dockerfile codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">FROM ruby:2.7</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">WORKDIR /app</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">COPY create-replication-user.rb /app</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">CMD [&quot;/usr/local/bin/ruby&quot;, &quot;/app/create-replication-user.rb&quot;, &quot;up&quot;]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The workflow to build and publish the container image is similar to:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">docker build -t a8s-pg-utilities </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">.</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">docker tag create-replication-user:latest fischerjulian/a8s-pg-utilities:latest</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">docker push fischerjulian/a8s-pg-utilities:latest</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The container image will allow the creation and deletion of the given replication user by specifying an optional argument:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/usr/local/bin/ruby&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/app/create-replication-user.rb&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;down&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>&quot;up&quot;</code> will create the replication user while <code>&quot;down&quot;</code> will delete it.
The action is idempotent in both directions.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="executing-the-script"></a>Executing the Script<a class="hash-link" href="#executing-the-script" title="Direct link to heading">#</a></h3><p>The next decision to be made is: how to execute the script.</p><p>So it&#x27;s worth thinking about what and when a replication user has to be created. For single node databases - that is <code>replicas: 1</code> - a replication user <strong>is not needed</strong>. Only if <code>replicas</code> is set to a value <code>2n * 1</code> with <code>n&gt;=1</code> such as <code>3, 5, ...</code> a replication user is required. </p><p>If you want to be prepared for automation failovers - where a Primary fails and one of the Secondaries is being elected and promoted to become the new leader - we need to create a replication user on each cluster node.</p><p>This is necessary to turn a Secondary into a primary node. In a <code>replicas: 3</code> scenario, this means 3 replica users will have to be created. One on each node.</p><p>It would therefore be desirable to have a way to declare wether a replication user is necessary or not. Then - comparing the desired vs. actual state - some kind of <em>controller</em> could ensure that the script is run.</p><p>Withouth such a controller one way to execute the script is using a Job.</p><p>The Job description pasted into <code>70-job-create-replication-user.yaml</code> looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> batch/v1</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Job</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> pg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">create</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">replication</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">user</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> create</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">replication</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">user</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> fischerjulian/a8s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">pg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">utilities</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">0.1.0</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># if the username is not set the script will assume the user &quot;postgres&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># - name: POSTGRES_USERNAME</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#   valueFrom:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#     secretKeyRef:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#       name: postgresql-secret-2</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#       key: POSTGRES_USERNAME</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_PASSWORD</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">secrets</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_PASSWORD</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_HOSTNAME</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">primary.pg.svc.cluster.local</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_REPLICATION_USERNAME</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">replication</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">user</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_REPLICATION_USERNAME</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_REPLICATION_PASSWORD</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> postgresql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">replication</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">user</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> POSTGRES_REPLICATION_PASSWORD</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                           </span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># imagePullPolicy: Always</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/usr/local/bin/ruby&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/app/create-replication-user.rb&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;up&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> OnFailure</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>For now it will be sufficient to run the Job to target the Primary. Later, when leader election will be implemented, the replication user must be created on all Pods.</p><p>Create the Job to execute the <code>create-replication-user.rb</code> script:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">kubectl apply -f </span><span class="token number" style="color:rgb(247, 140, 108)">70</span><span class="token plain">-job-create-replication-user.yaml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Verfiy this by connecting to the Primary and executing the following SQL command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly SQL"><pre tabindex="0" class="prism-code language-SQL codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">SELECT rolname FROM pg_catalog.pg_roles;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You should see the replication user.</p><p>After a few seconds your StatefulSet should have converged into the following state:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">NAME                               READY   STATUS      RESTARTS   AGE</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">pg-create-replication-user-zxt5c   </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">/1     Completed   </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">          139m</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">postgresql-sfs-0                   </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">/1     Running     </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">          138m</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">postgresql-sfs-1                   </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">/1     Running     </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">          138m</span></span><span class="token-line" style="color:#d6deeb"><span class="token plain">postgresql-sfs-2                   </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">/1     Running     </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">          138m</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We have now covered all necessary steps to set up the streaming replication.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>After defining the StatefulSet with its <code>3</code> replicas, a script to create the replication user had to be created. The script has been implemented to be idempotent which allows running it several times while the replication user is only created once. We had to make a decision how to deliver the script to the StatefulSet&#x27;s Pods and chose to use containerize it as a <em>utility</em> container image. This makes sense as the script will be shared across all data service instances and is unlikely to be changed very often.</p><p>With all the work you have invested so far, it is now time to use the streaming replication and verify that it&#x27;s working as expected.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="links"></a>Links<a class="hash-link" href="#links" title="Direct link to heading">#</a></h2><ol><li>An Introduction to Data Service Automation, Julian Fischer, {LINK TO BE DONE}</li><li>Ruby Docker Image on Dockerhub, <a href="https://hub.docker.com/_/ruby" target="_blank" rel="noopener noreferrer">https://hub.docker.com/_/ruby</a></li><li>Ruby PostgreSQL <code>pg</code> Gem, <a href="https://rubygems.org/gems/pg" target="_blank" rel="noopener noreferrer">https://rubygems.org/gems/pg</a></li><li>Ruby, <a href="https://www.ruby-lang.org/" target="_blank" rel="noopener noreferrer">https://www.ruby-lang.org/</a></li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/postgresql/building-the-pg-stateful-set/streaming-replication-sfs-init"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Initializing the StatefulSet</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/postgresql/building-the-pg-stateful-set/verify-replication"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Verifying the Replication Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-script" class="table-of-contents__link">The Script</a><ul><li><a href="#containerizing-the-script" class="table-of-contents__link">Containerizing the Script</a></li><li><a href="#executing-the-script" class="table-of-contents__link">Executing the Script</a></li></ul></li><li><a href="#summary" class="table-of-contents__link">Summary</a></li><li><a href="#links" class="table-of-contents__link">Links</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">More from anynines</h4><ul class="footer__items"><li class="footer__item"><a href="https://anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" rel="noopener noreferrer" class="footer__link-item">anynines.com</a></li><li class="footer__item"><a href="https://paas.anynines.com/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" rel="noopener noreferrer" class="footer__link-item">anynines PaaS</a></li><li class="footer__item"><a href="https://anynines.com/jobs/?utm_source=k8s-tutorial&amp;utm_medium=web" target="_blank" rel="noopener noreferrer" class="footer__link-item">Jobs at anynines</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Follow us</h4><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/anynines" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://www.linkedin.com/company/anynines/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn</a></li><li class="footer__item"><a href="https://instagram.com/anyninescom" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.anynines.com/imprint" target="_blank" rel="noopener noreferrer" class="footer__link-item">Imprint</a></li><li class="footer__item"><a href="https://www.anynines.com/data-privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2021 anynines GmbH.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3b2d4115.js"></script>
<script src="/assets/js/main.f17ba9dc.js"></script>
</body>
</html>