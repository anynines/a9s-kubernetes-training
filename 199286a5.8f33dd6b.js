(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{112:function(e,t,a){"use strict";a.d(t,"a",(function(){return b})),a.d(t,"b",(function(){return m}));var n=a(0),r=a.n(n);function s(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){s(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var c=r.a.createContext({}),p=function(e){var t=r.a.useContext(c),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},b=function(e){var t=p(e.components);return r.a.createElement(c.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=r.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,s=e.originalType,o=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),b=p(a),d=n,m=b["".concat(o,".").concat(d)]||b[d]||u[d]||s;return a?r.a.createElement(m,i(i({ref:t},c),{},{components:a})):r.a.createElement(m,i({ref:t},c))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var s=a.length,o=new Array(s);o[0]=d;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:n,o[1]=i;for(var c=2;c<s;c++)o[c]=a[c];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,a)}d.displayName="MDXCreateElement"},68:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return o})),a.d(t,"metadata",(function(){return i})),a.d(t,"rightToc",(function(){return l})),a.d(t,"default",(function(){return p}));var n=a(3),r=a(7),s=(a(0),a(112)),o={id:"stateful-set-postgresql",title:"PostgreSQL StatefulSet"},i={unversionedId:"kubernetes/80-stateful-sets/stateful-set-postgresql",id:"kubernetes/80-stateful-sets/stateful-set-postgresql",isDocsHomePage:!1,title:"PostgreSQL StatefulSet",description:"In the following set of exercises StatefulSets are presented in a practical manner. The PostgreSQL [11] RDBMS is used as an example as the databse is both widely known and of great utility to any developer. The goal of the exercises are not to build a production grade automation for PostgreSQL but to illustrate StatefulSet concepts.",source:"@site/docs/kubernetes/80-stateful-sets/30-postgresql-exercise.md",slug:"/kubernetes/80-stateful-sets/stateful-set-postgresql",permalink:"/kubernetes/80-stateful-sets/stateful-set-postgresql",version:"current",sidebar:"docs",previous:{title:"StatefulSets",permalink:"/kubernetes/80-stateful-sets/stateful-sets"},next:{title:"Headless Service",permalink:"/kubernetes/80-stateful-sets/stateful-set-headless-service"}},l=[{value:"Designing the StatefulSet",id:"designing-the-statefulset",children:[]},{value:"The Container Image",id:"the-container-image",children:[]},{value:"Creating a Secret",id:"creating-a-secret",children:[]},{value:"Creating a Service",id:"creating-a-service",children:[]},{value:"Creating the StatefulSet",id:"creating-the-statefulset",children:[]},{value:"Links",id:"links",children:[]}],c={rightToc:l};function p(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(s.b)("wrapper",Object(n.a)({},c,a,{components:t,mdxType:"MDXLayout"}),Object(s.b)("p",null,"In the following set of exercises StatefulSets are presented in a practical manner. The PostgreSQL ","[11]"," RDBMS is used as an example as the databse is both widely known and of great utility to any developer. The goal of the exercises are not to build a production grade automation for PostgreSQL but to illustrate StatefulSet concepts."),Object(s.b)("h2",{id:"designing-the-statefulset"},"Designing the StatefulSet"),Object(s.b)("p",null,"In order to create the PostgreSQL StatefulSet we proceed with the following steps:"),Object(s.b)("ul",null,Object(s.b)("li",{parentName:"ul"},"Identify or build (a) container image(s)"),Object(s.b)("li",{parentName:"ul"},"Specify a headless Service"),Object(s.b)("li",{parentName:"ul"},"Specify a StatefulSet"),Object(s.b)("li",{parentName:"ul"},"Provision the Service and StatefulSet"),Object(s.b)("li",{parentName:"ul"},"Conduct simple experiments")),Object(s.b)("p",null,"Start with finding a container image."),Object(s.b)("h2",{id:"the-container-image"},"The Container Image"),Object(s.b)("p",null,"An essential part of the StatefulSet for PostgreSQL is the database server itself. Luckily, there is no need to containerize PostgreSQL as this as already been done. Hence, use the official PostgreSQL Docker Image found at DockerHub ","[1]",". Pause this tutorial for a second and have a quick look at the ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://hub.docker.com/_/postgres"}),"description of the container image"),". This is where you'll find how the container image can be parameterized - a major challenge when creating the PostgreSQL StatefulSet. In particular, this is where you find out how to set a proper password. Try to find the corresponding setting yourself so that you understand the structure of the Secret described in the next section."),Object(s.b)("h2",{id:"creating-a-secret"},"Creating a Secret"),Object(s.b)("p",null,"Starting PostgreSQL requires an administator password which will be stored as a Secret."),Object(s.b)("p",null,"Create a PostgreSQL Secret containing the password for the admin user:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{}),"kubectl create secret generic postgresql-secrets --from-literal=POSTGRES_PASSWORD=tes6Aev8\n")),Object(s.b)("p",null,"Verify its creation:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{}),"kubectl describe secret postgresql-secrets\n")),Object(s.b)("h2",{id:"creating-a-service"},"Creating a Service"),Object(s.b)("p",null,"In order to provide a stable network identity to address the PostgreSQL server create a headless services by creating the file ",Object(s.b)("inlineCode",{parentName:"p"},"10-service.yaml"),":"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-yaml"}),"apiVersion: v1\nkind: Service\nmetadata:\n  name: postgresql-svc\n  labels:\n    app: postgresql-a\nspec:\n  ports:\n  - port: 5432\n    name: postgresql-port\n  clusterIP: None\n  selector:\n      app: postgresql-a\n")),Object(s.b)("p",null,"The attribute ",Object(s.b)("inlineCode",{parentName:"p"},"clusterIP: None")," of the Service specification denotes that this is a ",Object(s.b)("strong",{parentName:"p"},"headless Service"),"."),Object(s.b)("p",null,"Create the Service:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{}),"kubectl apply -f 10-service.yaml\n")),Object(s.b)("p",null,"Inspect the Service:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{}),"kubectl describe service postgresql-svc\n")),Object(s.b)("p",null,"The output should be similar to:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{}),"Name:              postgresql-svc\nNamespace:         default\nLabels:            app=postgresql-a\nAnnotations:       Selector:  app=postgresql-a\nType:              ClusterIP\nIP:                None\nPort:              postgresql-port  5432/TCP\nTargetPort:        5432/TCP\nEndpoints:         172.17.0.5:5432\nSession Affinity:  None\nEvents:            <none\n")),Object(s.b)("p",null,"Pay attention to the ",Object(s.b)("inlineCode",{parentName:"p"},"IP")," attribute."),Object(s.b)("p",null,"Normally, a Kubernetes Service has a cluster-internal IP address as seen in the ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"/kubernetes/40-replicaset-and-service/services"}),"Service example")," of the ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"/kubernetes/40-replicaset-and-service/introduction"}),"ReplicaSet lesson"),". Requests to the Service IP are then load balanced across the Service endpoints, e.g. Pods binding to the Service by using matching Labels."),Object(s.b)("p",null,"In constrast to a regular Service, ",Object(s.b)("strong",{parentName:"p"},"a headless Service does not have a cluster IP address"),". This is why it is declared using the ",Object(s.b)("inlineCode",{parentName:"p"},"ClusterIP: None")," declaration."),Object(s.b)("p",null,"So in constrast to a standard Service, ",Object(s.b)("strong",{parentName:"p"},"a headless Service does not perform load balancing"),". Depending on the selectors defined for the Service cluster-internal ",Object(s.b)("strong",{parentName:"p"},"DNS entries will be created"),"."),Object(s.b)("h2",{id:"creating-the-statefulset"},"Creating the StatefulSet"),Object(s.b)("p",null,"Now, with the preliminaries covered, the actual StatefulSet can be created in ",Object(s.b)("inlineCode",{parentName:"p"},"30-stateful-set.yaml"),":"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-yaml"}),'apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: postgresql-sfs\nspec:\n  selector:\n    matchLabels:\n      app: postgresql-a # has to match .spec.template.metadata.labels\n  serviceName: "postgresql-svc"\n  replicas: 1 # by default is 1\n  template:\n    metadata:\n      labels:\n        app: postgresql-a # has to match .spec.selector.matchLabels\n    spec:\n      terminationGracePeriodSeconds: 10\n      containers:\n      - name: postgresql-db\n        image: postgres:12.2\n        env:\n        - name: POSTGRES_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: postgresql-secrets\n              key: POSTGRES_PASSWORD\n        ports:\n        - containerPort: 5432\n          name: postgresql-port\n        volumeMounts:\n        - name: data\n          mountPath: /var/lib/postgresql/data\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes: [ "ReadWriteOnce" ]\n      storageClassName: "default"\n      resources:\n        requests:\n          storage: 1Gi\n')),Object(s.b)("p",null,"Have you noticed how the Secret is mounted as an environment variable as described in the container image description ","[1]","?"),Object(s.b)("p",null,"Also notice the ",Object(s.b)("inlineCode",{parentName:"p"},"volumeClaimTemplates")," section. The term ",Object(s.b)("em",{parentName:"p"},"Volume Claim Template")," indicates that this is not a Persistent Volume Claim (PVC). Consider the StatefulSet has specified mulitple ",Object(s.b)("inlineCode",{parentName:"p"},"replicas"),", three (3) for instance. In this case three Persistent Volume Claims need to be created. As each PVC is then parameterized with the individual replica's Pod identity, the actual Persistent Volume Claims are similar but not identical. The Persistent Volume Claim Template describes their commonalities."),Object(s.b)("p",null,"Execute the spec:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{}),"kubectl apply -f 30-stateful-set.yaml\n")),Object(s.b)("p",null,"List the StatefulSets:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{}),"kubectl get statefulsets\n")),Object(s.b)("p",null,"Describe the StatefulSet:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{}),"kubectl describe statefulset postgresql-sfs\n")),Object(s.b)("p",null,"In case your StatefulSet doesn't become ready you may want to investigate its Pod which can be selected using a Label."),Object(s.b)("p",null,"List the Pods of the StatefulSet by using its label ",Object(s.b)("inlineCode",{parentName:"p"},"app=postgresql-a"),":"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{}),"kubectl get pods -l app=postgresql-a\n")),Object(s.b)("p",null,"Your Pod may have entered the ",Object(s.b)("inlineCode",{parentName:"p"},"CrashLoopBackOff")," state as is failed to start several times in a row so it's time to do some detective work."),Object(s.b)("p",null,"By listing the Pods you have obtained the Pod name ",Object(s.b)("inlineCode",{parentName:"p"},"postgresql-sfs-0"),". The name perfectly demonstrates the Pod identity that comes as number ",Object(s.b)("inlineCode",{parentName:"p"},"0")," attached to the StatefulSet name ",Object(s.b)("inlineCode",{parentName:"p"},"postgresql-sfs"),"."),Object(s.b)("p",null,"Retrieve the Pod's logs:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{}),"kubectl logs postgresql-sfs-0\n")),Object(s.b)("p",null,"And you should see the entry:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{}),'The files belonging to this database system will be owned by user "postgres".\nThis user must also own the server process.\n\nThe database cluster will be initialized with locale "en_US.utf8".\nThe default database encoding has accordingly been set to "UTF8".\nThe default text search configuration will be set to "english".\n\nData page checksums are disabled.\n\ninitdb: error: directory "/var/lib/postgresql/data" exists but is not empty\nIt contains a lost+found directory, perhaps due to it being a mount point.\nUsing a mount point directly as the data directory is not recommended.\nCreate a subdirectory under the mount point.\n')),Object(s.b)("p",null,"The PostgreSQL Image description ","[1]"," says:"),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},"PGDATA This optional variable can be used to define another location - like a subdirectory - for the database files. The default is /var/lib/postgresql/data. If the data volume you're using is a filesystem mountpoint (like with GCE persistent disks) or remote folder that cannot be chowned to the postgres user (like some NFS mounts), Postgres initdb recommends a subdirectory be created to contain the data.")),Object(s.b)("p",null,"This means we have to tell PostgreSQL to change it's data directory to something like ",Object(s.b)("inlineCode",{parentName:"p"},"/var/lib/postgresql/data/pgdata")," by passing the path using the ",Object(s.b)("inlineCode",{parentName:"p"},"PGDATA")," environment variable."),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-yaml"}),'apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: postgresql-sfs\nspec:\n  selector:\n    matchLabels:\n      app: postgresql-a # has to match .spec.template.metadata.labels\n  serviceName: "postgresql-svc"\n  replicas: 1 # by default is 1\n  template:\n    metadata:\n      labels:\n        app: postgresql-a # has to match .spec.selector.matchLabels\n    spec:\n      terminationGracePeriodSeconds: 10\n      containers:\n      - name: postgresql-db\n        image: postgres:12.2\n        env:\n        - name: POSTGRES_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: postgresql-secrets\n              key: POSTGRES_PASSWORD\n        - name: PGDATA\n          value: /var/lib/postgresql/data/pgdata\n        ports:\n        - containerPort: 5432\n          name: postgresql-port\n        volumeMounts:\n        - name: data\n          mountPath: /var/lib/postgresql/data\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes: [ "ReadWriteOnce" ]\n      storageClassName: "default"\n      resources:\n        requests:\n          storage: 1Gi\n')),Object(s.b)("p",null,"First delete the existing StatefulSet:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{}),"kubectl delete statefulset postgresql-sfs\n")),Object(s.b)("p",null,"There is no problem with the Peristent Volume as it's empty (beside of the ",Object(s.b)("inlineCode",{parentName:"p"},"lost+found")," folder). So with the newly introduced environment variable ",Object(s.b)("inlineCode",{parentName:"p"},"PGDATA")," you can apply the spec again:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{}),"kubectl apply -f 30-stateful-set.yaml\n")),Object(s.b)("p",null,"And by executing:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{}),"kubectl get statefulset postgresql-sfs\n")),Object(s.b)("p",null,"You should see the StatefulSet being ",Object(s.b)("inlineCode",{parentName:"p"},"RUNNING"),"."),Object(s.b)("p",null,"Congratulations! You have deployed your first StatefulSet."),Object(s.b)("h2",{id:"links"},"Links"),Object(s.b)("ol",null,Object(s.b)("li",{parentName:"ol"},"PostgreSQL Docker Image at DockerHub, ",Object(s.b)("a",Object(n.a)({parentName:"li"},{href:"https://hub.docker.com/_/postgres"}),"https://hub.docker.com/_/postgres")),Object(s.b)("li",{parentName:"ol"},"Kubernetes Examples on GitHub, Persistent Volume Provisioning, ",Object(s.b)("a",Object(n.a)({parentName:"li"},{href:"https://github.com/kubernetes/examples/blob/master/staging/persistent-volume-provisioning/README.md"}),"https://github.com/kubernetes/examples/blob/master/staging/persistent-volume-provisioning/README.md")),Object(s.b)("li",{parentName:"ol"},"PostgreSQL Documentation - psql, ",Object(s.b)("a",Object(n.a)({parentName:"li"},{href:"https://www.postgresql.org/docs/12/app-psql.html"}),"https://www.postgresql.org/docs/12/app-psql.html")),Object(s.b)("li",{parentName:"ol"},"Kelsey Hightower @ Twitter, ",Object(s.b)("a",Object(n.a)({parentName:"li"},{href:"https://twitter.com/kelseyhightower/status/935252923721793536?lang=en"}),"https://twitter.com/kelseyhightower/status/935252923721793536?lang=en")),Object(s.b)("li",{parentName:"ol"},"Cloud Foundry, ",Object(s.b)("a",Object(n.a)({parentName:"li"},{href:"https://www.cloudfoundry.org/"}),"https://www.cloudfoundry.org/")),Object(s.b)("li",{parentName:"ol"},"Open Service Broker API, ",Object(s.b)("a",Object(n.a)({parentName:"li"},{href:"https://www.openservicebrokerapi.org/"}),"https://www.openservicebrokerapi.org/")),Object(s.b)("li",{parentName:"ol"},"anynines, a9s Data Services, ",Object(s.b)("a",Object(n.a)({parentName:"li"},{href:"https://www.anynines.com/data-services"}),"https://www.anynines.com/data-services")),Object(s.b)("li",{parentName:"ol"},"Kubernetes Documentation, Concepts, ServiceCatalog, ",Object(s.b)("a",Object(n.a)({parentName:"li"},{href:"https://kubernetes.io/docs/concepts/extend-kubernetes/service-catalog/"}),"https://kubernetes.io/docs/concepts/extend-kubernetes/service-catalog/")),Object(s.b)("li",{parentName:"ol"},"Wikipedia, Principle of Least Privilege, ",Object(s.b)("a",Object(n.a)({parentName:"li"},{href:"https://en.wikipedia.org/wiki/Principle_of_least_privilege"}),"https://en.wikipedia.org/wiki/Principle_of_least_privilege")),Object(s.b)("li",{parentName:"ol"},"Kubernetes Documentation, Concepts, Services Networking, Service, ",Object(s.b)("a",Object(n.a)({parentName:"li"},{href:"https://kubernetes.io/docs/concepts/services-networking/service/#headless-services"}),"https://kubernetes.io/docs/concepts/services-networking/service/#headless-services")," "),Object(s.b)("li",{parentName:"ol"},"PostgreSQL, ",Object(s.b)("a",Object(n.a)({parentName:"li"},{href:"https://www.postgresql.org/"}),"https://www.postgresql.org/"))))}p.isMDXComponent=!0}}]);