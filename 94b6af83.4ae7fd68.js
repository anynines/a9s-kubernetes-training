(window.webpackJsonp=window.webpackJsonp||[]).push([[43],{180:function(e,t,r){"use strict";r.r(t),r.d(t,"frontMatter",(function(){return o})),r.d(t,"metadata",(function(){return l})),r.d(t,"rightToc",(function(){return c})),r.d(t,"default",(function(){return p}));var n=r(2),a=r(9),i=(r(0),r(198)),o={id:"verify-replication",title:"Verifying the Replication"},l={id:"postgresql/40-building-the-pg-stateful-set/verify-replication",isDocsHomePage:!1,title:"Verifying the Replication",description:"Verifying the Streaming Replication",source:"@site/docs/postgresql/40-building-the-pg-stateful-set/50-verify-replication.md",permalink:"/postgresql/40-building-the-pg-stateful-set/verify-replication",sidebar:"docs",previous:{title:"Creating a Replication User",permalink:"/postgresql/40-building-the-pg-stateful-set/replication-user"},next:{title:"Outro",permalink:"/postgresql/postgresql-outro"}},c=[{value:"Verifying the Streaming Replication",id:"verifying-the-streaming-replication",children:[]},{value:"Writing Data to the Primary",id:"writing-data-to-the-primary",children:[]},{value:"Reading Data from a Secondary",id:"reading-data-from-a-secondary",children:[]},{value:"Summary",id:"summary",children:[]},{value:"What&#39;s Missing?",id:"whats-missing",children:[{value:"Failure Detection, Leader Election and Leader Promotion",id:"failure-detection-leader-election-and-leader-promotion",children:[]}]},{value:"Sources and Links",id:"sources-and-links",children:[]}],s={rightToc:c};function p(e){var t=e.components,r=Object(a.a)(e,["components"]);return Object(i.b)("wrapper",Object(n.a)({},s,r,{components:t,mdxType:"MDXLayout"}),Object(i.b)("h2",{id:"verifying-the-streaming-replication"},"Verifying the Streaming Replication"),Object(i.b)("p",null,"Now that everything is setup, it's time to verify that the streaming replication works. For this, we will write data to the Primary and ensure it can be read from the Secondaries shortly after."),Object(i.b)("h2",{id:"writing-data-to-the-primary"},"Writing Data to the Primary"),Object(i.b)("p",null,"Connect to the Primary Pod:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{}),"kubectl exec -it postgresql-sfs-0 -- bash\n")),Object(i.b)("p",null,"And within the Pod connect to the Primary PostgreSQL server:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{}),"psql -U postgres\n")),Object(i.b)("p",null,"Inside ",Object(i.b)("inlineCode",{parentName:"p"},"psql")," select the ",Object(i.b)("inlineCode",{parentName:"p"},"postgres")," database:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{}),"\\c postgres\n")),Object(i.b)("p",null,"And create a table:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{}),"CREATE TABLE COMPANY(\n  ID INT PRIMARY KEY     NOT NULL,\n  NAME           TEXT    NOT NULL\n); \n")),Object(i.b)("p",null,"Insert a record:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{}),"INSERT INTO COMPANY (ID, NAME) VALUES (1, 'anynines GmbH');\n")),Object(i.b)("p",null,"The record should now be streamed to all Secondaries."),Object(i.b)("h2",{id:"reading-data-from-a-secondary"},"Reading Data from a Secondary"),Object(i.b)("p",null,"Connect to a Secondary Pod such as ",Object(i.b)("inlineCode",{parentName:"p"},"postgresql-sfs-1"),":"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{}),"kubectl exec -it postgresql-sfs-1 -- bash\n")),Object(i.b)("p",null,"And execute:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{}),"psql -U postgres\n")),Object(i.b)("p",null,"Within ",Object(i.b)("inlineCode",{parentName:"p"},"psql")," run:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{}),"\\c postgres\n\nSELECT * FROM COMPANY;\n")),Object(i.b)("p",null,"The output should look like this:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{})," id |     name\n----+---------------\n  1 | anynines GmbH\n(1 row)\n")),Object(i.b)("p",null,"Repeat the above procedure for the other Secondary node ",Object(i.b)("inlineCode",{parentName:"p"},"postgresql-sfs-2"),". It should also return the record you've inserted."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Congratulations! You have set up a PostgreSQL streaming cluster on Kubernets"),"."),Object(i.b)("h2",{id:"summary"},"Summary"),Object(i.b)("p",null,"You have learned about PostgreSQL streaming replication and in particular mastered how it works and how it is configured. More than that you have transferred this knowledge and containerized the configuration overcoming many little hurdles on the way."),Object(i.b)("p",null,"At this point, the PostreSQL automation sets up a streaming replication what will stream changes of the Primary to all its Secondaries."),Object(i.b)("h2",{id:"whats-missing"},"What's Missing?"),Object(i.b)("p",null,"As long as the cluster is healthy, the streaming replication will provide a near real-time backup of the Primary database. However, there is much more work to be done which goes beyond the scope of this lesson."),Object(i.b)("p",null,"Beside of some security related improvements, there is more to add to the automation so that the streaming replication take full effect in production."),Object(i.b)("h3",{id:"failure-detection-leader-election-and-leader-promotion"},"Failure Detection, Leader Election and Leader Promotion"),Object(i.b)("p",null,"Currently, there is no mechanism in place that detects a failing Primary. Theoretically there are two Secondaries which may be up to date with the failed Primary or they may lag a little behind resulting into a data loss of the replication lag's size."),Object(i.b)("p",null,"Detecting a failed Primary seems to be a simple task but as we are dealing with a distributed syste, sadly this is a non-trivial problem going back to the Byzantine General Problem ","[1]",". The health monitor should be fault tolerant itself which means that it should be spread equally across cluster nodes. If the health manager itself is distributed it becomes hard to distinguish a failed Primary from a failed connection between a Secondary and the Primary. Especially in the case of network segmentation, applications may still have access to the Primary while a Secondary may think it's his time to take over leadership. There are algorithms solving leader election problem with a satisfying level of reliability. These so called ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://en.wikipedia.org/wiki/Consensus_algorithm"}),"consensus algorithms")," ","[2]"," can be rather complex. The most popular two algorithms include ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://en.wikipedia.org/wiki/Paxos_(computer_science)"}),"Paxos")," ","[3]"," and ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://en.wikipedia.org/wiki/Raft_(computer_science)"}),"RAFT")," ","[4]","."),Object(i.b)("h2",{id:"sources-and-links"},"Sources and Links"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"https://en.wikipedia.org/wiki/Byzantine_fault"}),"https://en.wikipedia.org/wiki/Byzantine_fault")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"https://en.wikipedia.org/wiki/Consensus_algorithm"}),"https://en.wikipedia.org/wiki/Consensus_algorithm")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"https://en.wikipedia.org/wiki/Paxos_(computer_science)"}),"https://en.wikipedia.org/wiki/Paxos_(computer_science)")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"https://en.wikipedia.org/wiki/Raft_(computer_science)"}),"https://en.wikipedia.org/wiki/Raft_(computer_science)"))))}p.isMDXComponent=!0},198:function(e,t,r){"use strict";r.d(t,"a",(function(){return b})),r.d(t,"b",(function(){return h}));var n=r(0),a=r.n(n);function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){i(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function c(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=a.a.createContext({}),p=function(e){var t=a.a.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):l(l({},t),e)),r},b=function(e){var t=p(e.components);return a.a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},u=a.a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,i=e.originalType,o=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),b=p(r),u=n,h=b["".concat(o,".").concat(u)]||b[u]||d[u]||i;return r?a.a.createElement(h,l(l({ref:t},s),{},{components:r})):a.a.createElement(h,l({ref:t},s))}));function h(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=r.length,o=new Array(i);o[0]=u;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:n,o[1]=l;for(var s=2;s<i;s++)o[s]=r[s];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,r)}u.displayName="MDXCreateElement"}}]);