"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[8566],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return d}});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,s=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),m=u(n),d=i,h=m["".concat(l,".").concat(d)]||m[d]||c[d]||s;return n?a.createElement(h,r(r({ref:t},p),{},{components:n})):a.createElement(h,r({ref:t},p))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var s=n.length,r=new Array(s);r[0]=m;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:i,r[1]=o;for(var u=2;u<s;u++)r[u]=n[u];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},36455:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return u},metadata:function(){return p},toc:function(){return c},default:function(){return h}});var a,i=n(87462),s=n(63366),r=(n(67294),n(3905)),o=["components"],l={id:"persistent-volumes-exercise",title:"Persistent Volumes Excercise"},u=void 0,p={unversionedId:"kubernetes/stateful-sets/persistent-volumes-exercise",id:"kubernetes/stateful-sets/persistent-volumes-exercise",isDocsHomePage:!1,title:"Persistent Volumes Excercise",description:"Related Videos",source:"@site/docs/kubernetes/80-stateful-sets/15-persistent-volumes-exercise.md",sourceDirName:"kubernetes/80-stateful-sets",slug:"/kubernetes/stateful-sets/persistent-volumes-exercise",permalink:"/kubernetes/stateful-sets/persistent-volumes-exercise",tags:[],version:"current",sidebarPosition:15,frontMatter:{id:"persistent-volumes-exercise",title:"Persistent Volumes Excercise"},sidebar:"docs",previous:{title:"Persistent Volumes",permalink:"/kubernetes/stateful-sets/persistent-volumes"},next:{title:"StatefulSets",permalink:"/kubernetes/stateful-sets/stateful-sets"}},c=[{value:"Related Videos",id:"related-videos",children:[]},{value:"Creating a Storage Class",id:"creating-a-storage-class",children:[]},{value:"Creating a Persistent Volume Claim",id:"creating-a-persistent-volume-claim",children:[]},{value:"Tidying Up",id:"tidying-up",children:[]},{value:"Links",id:"links",children:[]}],m=(a="VideoContainer",function(e){return console.warn("Component "+a+" was not imported, exported, or provided by MDXProvider as global scope"),(0,r.kt)("div",e)}),d={toc:c};function h(e){var t=e.components,n=(0,s.Z)(e,o);return(0,r.kt)("wrapper",(0,i.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"related-videos"},"Related Videos"),(0,r.kt)(m,{list:[{src:"https://www.youtube-nocookie.com/embed/uSXqAr83ljs",title:"Persistent Volume Exercise Part 1"},{src:"https://www.youtube-nocookie.com/embed/bM3ZtKN1BSw",title:"Persistent Volume Exercise Part 2"}],mdxType:"VideoContainer"}),(0,r.kt)("p",null,"After going through the theory of Volumes and Persistent Volumes it's time to get your hands down. In this exercise you will create a stateful Pod using Persistent Volumes. As you will see this can involve a few preliminary steps. Since the exercise is executed on minikube, we already have a default storage class, but when using for example ",(0,r.kt)("inlineCode",{parentName:"p"},"paas.anynines.com")," which is the ",(0,r.kt)("inlineCode",{parentName:"p"},"a9s Kubernetes")," automation deployed on AWS, storage classes might have to be setup first ","[1]",". "),(0,r.kt)("p",null,"Storage is one of the places where rubber meets the road in the sense that there is a comparatively large contact surface with infrastructure. This is why - similar to Ingresses in an earlier lesson - Persistent Volumes involve vendor specific configuration. If you look closer at the exercise you will also recognize that the Kubernetes abstraction from volume Provisioners, Storage Classes, Persistent Volume Claims, Persistent Volumes to Volumes helps to maintain the tie to a specific Kubernetes distribution to a minimum. This counteracts the initial impression why dealing with persistency in Kubernetes is so surprisingly complicated."),(0,r.kt)("h2",{id:"creating-a-storage-class"},"Creating a Storage Class"),(0,r.kt)("p",null,"Since minikube already comes setup with a storage class, we will in this section take a look on how you would add one to ",(0,r.kt)("inlineCode",{parentName:"p"},"a9s Kubernetes"),"."),(0,r.kt)("p",null,"For that you would create a file ",(0,r.kt)("inlineCode",{parentName:"p"},"05-storage-class.yaml"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n    name: default\nparameters:\n    encrypted: "false"\n    type: gp2\nprovisioner: kubernetes.io/aws-ebs\nreclaimPolicy: Delete\nvolumeBindingMode: Immediate\nallowVolumeExpansion: false\n')),(0,r.kt)("p",null,"This Storage Class makes use of the provisioner ",(0,r.kt)("inlineCode",{parentName:"p"},"kubernetes.io/aws-ebs"),". In this particular example, the provisioner uses storage services of the Amazon Web Services ","[1]","."),(0,r.kt)("p",null,"You may ask yourself how the provisioner authenticates against the AWS API. As this is beyond the scope of this training it should suffice to say that the Kubernetes cluster administrator - or a proper automation respectively - has configured a so-called Cloud Provider ","[2]",". A Cloud Provider enables access to multiple services offered by the corresponding vendor often including infrastructure affine services such as load balancing and storage."),(0,r.kt)("p",null,"For now, you can be relieved as the Cloud Provider already has been configured for you."),(0,r.kt)("p",null,"So you would then just have to apply the Storage Class by executing:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl apply -f 05-storage-class.yaml\n")),(0,r.kt)("h2",{id:"creating-a-persistent-volume-claim"},"Creating a Persistent Volume Claim"),(0,r.kt)("p",null,"Create a file ",(0,r.kt)("inlineCode",{parentName:"p"},"10-persistent-volume-claim.yaml"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: simple-pv-claim\nspec:\n  storageClassName: standard\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 1Gi\n")),(0,r.kt)("p",null,"Create a Persistent Volume Claim:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl apply -f 10-persistent-volume-claim.yaml\n")),(0,r.kt)("p",null,"Verify that the Persistent Volume Claim has been created successfully and - most importantly - that a Persistent Volume has been claimed:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl get pvc -w\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"-w")," option will update the output continuously. You can interrupt it using ",(0,r.kt)("inlineCode",{parentName:"p"},"<CTRL>+C"),"."),(0,r.kt)("p",null,"Output should look similar to:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nsimple-pv-claim   Bound    pvc-7a0e4339-9e64-4740-9adb-a509a6aac328   1Gi        RWO            default        49s\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"STATUS")," field should say ",(0,r.kt)("inlineCode",{parentName:"p"},"BOUND"),'and thus indicate that an actual Persistent Volume has been found and "bound" to the Persistent Volume Claim.'),(0,r.kt)("p",null,"In this case - with knowledge about the ",(0,r.kt)("inlineCode",{parentName:"p"},"standard")," Storage Class available on minikube, we know how this has happened."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"k8s.io/minikube-hostpath")," Provisioner has created a Persistent Volume according to the needs specified in the Persistent Volume Claim. This is illustrated when describing the PVC:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl describe pvc simple-pv-claim\n")),(0,r.kt)("p",null,"The output should look like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'Name:          simple-pv-claim\nNamespace:     k8s-training\nStorageClass:  standard\nStatus:        Bound\nVolume:        pvc-802aa3a1-1d0d-4f9a-81bb-84ecce66b5cc\nLabels:        <none>\nAnnotations:   pv.kubernetes.io/bind-completed: yes\n           pv.kubernetes.io/bound-by-controller: yes\n           volume.beta.kubernetes.io/storage-provisioner: k8s.io/minikube-hostpath\n           volume.kubernetes.io/storage-provisioner: k8s.io/minikube-hostpath\nFinalizers:    [kubernetes.io/pvc-protection]\nCapacity:      1Gi\nAccess Modes:  RWO\nVolumeMode:    Filesystem\nUsed By:       <none>\nEvents:\n  Type    Reason                 Age   From                                                                    Message\n  ----    ------                 ----  ----                                                                    -------\n  Normal  Provisioning           9s    k8s.io/minikube-hostpath_minikube_6fce3804-fe83-4341-b060-bcb0baea22fb  External provisioner is provisioning volume for claim "default/simple-pv-claim"\n  Normal  ExternalProvisioning   9s    persistentvolume-controller                                             waiting for a volume to be created, either by external provisioner "k8s.io/minikube-hostpath" or manually created by system administrator\n  Normal  ProvisioningSucceeded  9s    k8s.io/minikube-hostpath_minikube_6fce3804-fe83-4341-b060-bcb0baea22fb  Successfully provisioned volume pvc-802aa3a1-1d0d-4f9a-81bb-84ecce66b5cc\n')),(0,r.kt)("p",null,"This provides you with the information that:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The provisioner ",(0,r.kt)("inlineCode",{parentName:"li"},"k8s.io/minikube-hostpath")," has created a Persistent Volume with the id ",(0,r.kt)("inlineCode",{parentName:"li"},"pvc-802aa3a1-1d0d-4f9a-81bb-84ecce66b5cc"),"."),(0,r.kt)("li",{parentName:"ul"},"The Persistent Volume is a filesystem (",(0,r.kt)("inlineCode",{parentName:"li"},"VolumeMode: Filesystem"),")."),(0,r.kt)("li",{parentName:"ul"},"The Persistent Volume is currently not mounted.")),(0,r.kt)("p",null,"Hence, it's time to create a Pod and mount the Persistent Volume."),(0,r.kt)("p",null,"Create a file ",(0,r.kt)("inlineCode",{parentName:"p"},"20-pod-writing-to-volume.yaml"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Pod\nmetadata:\nname: simple-pv-pod\nspec:\nvolumes:\n    - name: simple-pv-storage\n    persistentVolumeClaim:\n        claimName: simple-pv-claim\ncontainers:\n    - name: simple-pv-container\n    image: busybox\n    command: ["/bin/sh"]\n    args: ["-c", "echo Hello World > /my-persistent-data/helloworld.txt"]\n    volumeMounts:\n        - mountPath: "/my-persistent-data"\n        name: simple-pv-storage\nrestartPolicy: Never\n')),(0,r.kt)("p",null,"Which creates a Pod writing a simple text file ",(0,r.kt)("inlineCode",{parentName:"p"},"/my-persistent-data/helloworld.txt")," containing the String ",(0,r.kt)("inlineCode",{parentName:"p"},"Hello World"),"."),(0,r.kt)("p",null,"So now there is data on the disk of this Pod which will terminate after its execution."),(0,r.kt)("p",null,"Create another Pod, mount the same Persistent Volume and read the data printing it to the STDOUT:"),(0,r.kt)("p",null,"Create a file ",(0,r.kt)("inlineCode",{parentName:"p"},"30-pod-reading-from-volume.yaml"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Pod\nmetadata:\nname: simple-pv-pod-reader\nspec:\nvolumes:\n    - name: simple-pv-storage\n    persistentVolumeClaim:\n        claimName: simple-pv-claim\ncontainers:\n    - name: simple-pv-container\n    image: busybox\n    command: ["/bin/sh"]\n    args: ["-c", "cat /my-persistent-data/helloworld.txt"]\n    volumeMounts:\n        - mountPath: "/my-persistent-data"\n        name: simple-pv-storage\nrestartPolicy: Never\n')),(0,r.kt)("p",null,"And retrieve the Pods logs:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl logs simple-pv-pod-reader\n")),(0,r.kt)("p",null,"Which should output:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Hello World\n")),(0,r.kt)("h2",{id:"tidying-up"},"Tidying Up"),(0,r.kt)("p",null,"Remove created objects:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl delete pod simple-pv-pod\nkubectl delete pod simple-pv-pod-reader\n")),(0,r.kt)("p",null,"Execute:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl get pvc\n")),(0,r.kt)("p",null,"Can you see that the Persistent Volume Claim and the Persistent Volume still exists? Their lifecycle is independent of the lifecycle of the Pods you have created. So it's worth keeping in mind that the lifecycle is a major difference between Volumes and Persistent Volumes."),(0,r.kt)("p",null,"Delete the Persistent Volume Claim:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl delete pvc simple-pv-claim\n")),(0,r.kt)("p",null,"And ensure that the associated persistent volume has been deleted, too:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl get pv\n")),(0,r.kt)("p",null,"And it's gone."),(0,r.kt)("p",null,"You have learned how to create a Persistent Volume using a Persistent Volume Claim. Although this example uses a Pod for illustration purposes, you are more likely to use Persistent Volumes as part of StatefulSets."),(0,r.kt)("h2",{id:"links"},"Links"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Amazon Web Services, ",(0,r.kt)("a",{parentName:"li",href:"http://aws.amazon.com/"},"http://aws.amazon.com/")),(0,r.kt)("li",{parentName:"ol"},"Kubernetes Documentation, Concepts, Cluster-Administration, Cloud Providers, ",(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/concepts/cluster-administration/cloud-providers/#aws"},"https://kubernetes.io/docs/concepts/cluster-administration/cloud-providers/#aws"))))}h.isMDXComponent=!0}}]);