"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[8460],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return m}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),c=p(n),h=r,m=c["".concat(l,".").concat(h)]||c[h]||u[h]||o;return n?a.createElement(m,s(s({ref:t},d),{},{components:n})):a.createElement(m,s({ref:t},d))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,s=new Array(o);s[0]=h;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[c]="string"==typeof e?e:r,s[1]=i;for(var p=2;p<o;p++)s[p]=n[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},9457:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return i},metadata:function(){return p},toc:function(){return c}});var a=n(7462),r=n(3366),o=(n(7294),n(3905)),s=["components"],i={slug:"/advanced-kubernetes/liveness-probe-exercise",id:"liveness-probe-exercise",title:"Liveness Probe Exercise"},l=void 0,p={unversionedId:"kubernetes2/module-advanced-pods/liveness-probe-exercise",id:"kubernetes2/module-advanced-pods/liveness-probe-exercise",title:"Liveness Probe Exercise",description:"In this exercise a simple demo application is used. The demo app allows",source:"@site/docs/kubernetes2/module-advanced-pods/22-excercise-liveness.md",sourceDirName:"kubernetes2/module-advanced-pods",slug:"/advanced-kubernetes/liveness-probe-exercise",permalink:"/advanced-kubernetes/liveness-probe-exercise",draft:!1,tags:[],version:"current",sidebarPosition:22,frontMatter:{slug:"/advanced-kubernetes/liveness-probe-exercise",id:"liveness-probe-exercise",title:"Liveness Probe Exercise"},sidebar:"docs",previous:{title:"Container Probes",permalink:"/advanced-kubernetes/container-probes"},next:{title:"Readiness and Startup Probes Exercise",permalink:"/advanced-kubernetes/readines-startup-probe-exercise"}},d={},c=[{value:"Exercise: Mark a Pod as Unhealthy",id:"exercise-mark-a-pod-as-unhealthy",level:2},{value:"Conclusion",id:"conclusion",level:2},{value:"Sources and Links",id:"sources-and-links",level:2}],u={toc:c},h="wrapper";function m(e){var t=e.components,i=(0,r.Z)(e,s);return(0,o.kt)(h,(0,a.Z)({},u,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"In this exercise a simple demo application is used. The demo app allows\nthe simulation application states such as being healthy or unhealthy as well as behavior such as long startup durations."),(0,o.kt)("p",null,"First, the application's default behavior is examined."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"60-deployment-lvn.yml"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: adv-pod-conf-depl\n  labels:\n      app: adv-pod-conf\nspec:\n  selector:\n    matchLabels:\n      app: adv-pod-conf\n  replicas: 3\n  template:\n    metadata:\n      labels:\n        app: adv-pod-conf\n    spec:\n      containers:\n      - name: adv-pod-conf-con\n        image: fischerjulian/apc-demo-app:0.6.0\n        ports:\n          - containerPort: 4567\n        env:\n          - name: MY_POD_IP\n            valueFrom:\n              fieldRef:\n                fieldPath: status.podIP\n        livenessProbe:\n          httpGet:\n            path: /healthz\n            port: 4567            \n          initialDelaySeconds: 3\n          periodSeconds: 3\n")),(0,o.kt)("p",null,"Per default, the application starts without a delay and enters a healthy state. It offers a simple UI showing the IP address of the particular Pod which served the request. Furthermore, it provides a simple form to set the health state to either ",(0,o.kt)("em",{parentName:"p"},"Healthy"),"  or ",(0,o.kt)("em",{parentName:"p"},"Unhealthy"),". HTTP response codes to the ",(0,o.kt)("inlineCode",{parentName:"p"},"/healthz")," endpoint depend on this health state. The response code will be ",(0,o.kt)("inlineCode",{parentName:"p"},"200")," if set to ",(0,o.kt)("em",{parentName:"p"},"Healthy")," and some HTTP error code if set to ",(0,o.kt)("em",{parentName:"p"},"Unhealthy"),". This allows us to simulate failing pods by changing their health state. The health state is stored in the pod's ephemeral file system. When using with a Service load-balancing across several replicas of a Deployment, the health state affects only the particular pod which served the request. In other words, you can make a particular pod of a Deployment's ReplicaSet fail."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Advance Pod Configuration Demo App Screenshot",src:n(8091).Z,width:"496",height:"289"})),(0,o.kt)("p",null,"In a real world example, the purpose of the ",(0,o.kt)("inlineCode",{parentName:"p"},"/healthz")," would be to make an educated guess about the application's true health. An application still running application server process but which lost its ability to serve requests, for example."),(0,o.kt)("p",null,"An ",(0,o.kt)("inlineCode",{parentName:"p"},"httpGet")," Liveness Probe to poll the ",(0,o.kt)("inlineCode",{parentName:"p"},"/healthz")," endpoint can be used:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-YAML"},"livenessProbe:\n  httpGet:\n    path: /healthz\n    port: 4567            \n  initialDelaySeconds: 3\n  periodSeconds: 3\n")),(0,o.kt)("p",null,"This Liveness Probe will wait for ",(0,o.kt)("inlineCode",{parentName:"p"},"3s")," as configured with ",(0,o.kt)("inlineCode",{parentName:"p"},"initialDelaySeconds")," before executing the first probe. This allows the application to set up and start serving requests. After the initial delay, the Liveness Probe will be repeated every ",(0,o.kt)("inlineCode",{parentName:"p"},"periodSeconds"),", in this case every ",(0,o.kt)("inlineCode",{parentName:"p"},"3s"),"."),(0,o.kt)("p",null,"Whenever the Liveness Probe fails, Kubernetes (the Kubelet on the Node) will consider the corresponding pod to have failed. Depending on the pod's ",(0,o.kt)("inlineCode",{parentName:"p"},"restartPolicy")," ","[1]",", the pod will be restarted.\nWhile a restart may not resolve the underlying issue, in many cases it will recover a failed Pod by replacing it with a functioning one. This may buy the time for the engineers to sleep through the night and take care of the issues as a regular work item rather than an expedited one."),(0,o.kt)("h2",{id:"exercise-mark-a-pod-as-unhealthy"},"Exercise: Mark a Pod as Unhealthy"),(0,o.kt)("p",null,"See for yourself and mark a Pod as ",(0,o.kt)("em",{parentName:"p"},"Unhealthy"),". Within the ",(0,o.kt)("inlineCode",{parentName:"p"},"periodSeconds")," the failure should be detected and you should see a restarting pod."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"NAME                                READY   STATUS    RESTARTS   AGE\nadv-pod-conf-depl-9b6f56758-42pjv   1/1     Running   0          84m\nadv-pod-conf-depl-9b6f56758-gc9fr   1/1     Running   0          84m\nadv-pod-conf-depl-9b6f56758-gphjm   1/1     Running   0          84m\n")),(0,o.kt)("p",null,"After a few seconds a pod restart can be observed."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"NAME                                READY   STATUS    RESTARTS   AGE\nadv-pod-conf-depl-9b6f56758-42pjv   1/1     Running   1 (0s ago)   84m\n")),(0,o.kt)("p",null,"Look at the pod's details using this command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"kubectl describe pod adv-pod-conf-depl-9b6f56758-42pjv\n")),(0,o.kt)("p",null,"Revealing the livecycle event of a failed Liveness Probe:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Events:\n  Type     Reason     Age                From     Message\n  ----     ------     ----               ----     -------\n  Warning  Unhealthy  88s (x3 over 94s)  kubelet  Liveness probe failed: HTTP probe failed with statuscode: 403\n")),(0,o.kt)("h2",{id:"conclusion"},"Conclusion"),(0,o.kt)("p",null,"In this exercise you have witnessed extended self-healing capabilities of Kubernetes pods. While - per default - a pod is restarted if one of its container processes exits with a non-zero return value, Liveness Probes provide a mechanism to define custom probes to detect failed applications beyond their container process exit codes. In this example, you have used the ",(0,o.kt)("inlineCode",{parentName:"p"},"httpGet")," variant of the Liveness probe but there are also other probing mechanism that you may want to discover yourself. Standard probing mechanisms work similar for Livess, Readiness and Startup Probes and include:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"exec")," - Execute a probing command within the container using the command's exit code as a result with ",(0,o.kt)("inlineCode",{parentName:"li"},"0")," indicating success."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"httpGet")," - Perform an HTTP requests using the HTTP response code to determine success. Success is assumed with response codes between ",(0,o.kt)("inlineCode",{parentName:"li"},"200")," and anything below ",(0,o.kt)("inlineCode",{parentName:"li"},"400"),"."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"tcpSocket")," Executes a TCP check against the pod's IP address on the specified port. The diagnostic is considered successful if the port is open."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"grpc")," - Performs a remote procedure call using gRPC. ")),(0,o.kt)("p",null,"See ","[2]"," and ","[3]"," for more details about Container Probes."),(0,o.kt)("h2",{id:"sources-and-links"},"Sources and Links"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Kubernetes Documentation / Concepts / Workloads / Pods / Pod Lifecycle # Container restart policy, ",(0,o.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy"},"https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy")),(0,o.kt)("li",{parentName:"ol"},"Kubernetes Documentation / Tasks / Configure Pods and Containers / Configure Liveness / Readiness and Startup Probes / Configure Liveness / Readiness and Startup Probes, ",(0,o.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/"},"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/")),(0,o.kt)("li",{parentName:"ol"},"Kubernetes Documentation / Concepts / Workloads / Pods / Pod Lifecycle # Container Probes, ",(0,o.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#container-probes"},"https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#container-probes"))))}m.isMDXComponent=!0},8091:function(e,t,n){t.Z=n.p+"assets/images/apc-demo-app-3c1da3d71dcb1a27fae2d1ef972d4b32.png"}}]);